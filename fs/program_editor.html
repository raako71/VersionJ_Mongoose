<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<link rel="stylesheet" href="dtsel.css" />
	<script src="dtsel.js"></script>
	<title> Power Monitor Web Server | Editor</title>
</head>
<body>

<h1> Program Editor Page </h1>
<div class="main_container">
<table>
<td style="width:175px">
Custom Program Name:
</td>
<td>
<input type="text" id="program_name" placeholder="custom name" style="height:20px">
</td>
</table>
<br>
<table>
<td style="width:175px">
Program Enable:
</td>
<td>
<label class="switch"> 
<input type="checkbox" id="program_en" >
<span class="slider round"></span>
</label>
</td>
</table>
</div>
<div class="main_container">
<table>
<td style="width:175px">
Start Date
</td>
<td>
	<label class="switch"> 
	<input type="checkbox" id="start_date_en" onClick="toggle('start_date')">
	<span class="slider round"></span>
	</label>
</td>
<td id="start_date_container" style="padding-left:20px">
</td>

</table>

</div>
<div class="main_container">
<table>
<tr>
<td style="width:175px"> End Date </td>
<td>
	<label class="switch">
	<input type="checkbox" id="end_date_en" onClick="toggle('end_date')">
	<span class="slider round"></span>
	</label>
</td>
<td id="end_date_container" style="padding-left:20px">
</td>
</table>
</div>

<div class="main_container">
<table>
<tr>
<td style="width:175px"> Days per Week </td>
<td>
	<label class="switch">
	<input type="checkbox" id="day_list_en" onClick="toggle_day()" >
	<span class="slider round"></span>
	</label>
</td>
<td id="day_list_container" style="padding-left:20px">
</td>
</tr>

</table>
</div>

<div class="main_container">
<table>
<tr>
<td style="width:175px"> On Time </td>
<td>
	<label class="switch">
	<input type="checkbox" id="on_time_en" onClick="toggle('on_time')">
	<span class="slider round"></span>
	</label>
</td>
<td id="on_time_container" style="padding-left:20px">
</td>
</table>
</div>
<div class="main_container">
<table>
<tr>
<td style="width:175px"> Off Time</td>
<td>
	<label class="switch">
	<input type="checkbox" id="off_time_en" onClick="toggle('off_time')">
	<span class="slider round"></span>
	</label>
</td>
<td id="off_time_container" style="padding-left:20px">
</td>
</table>
</div>

<div class="main_container">
<label for="ctrl_output">Control Outputs:</label>
<select name="ctrl_output" id="ctrl_out_opt" >
  <option value=1>A</option>
  <option value=2>B</option>
  <option value=3>LED RED</option>
  <option value=4>IO14</option>
</select>
</div>

<div class="main_container" style="border:1px solid; border-radius:10px; padding:10px" id="ctrl_trigger_holder_1">
<label for="ctrl_trigger">Control Trigger:</label>
<select name="ctrl_trigger" id="ctrl_trigger" onChange="load_ctrl_action();">
  <option value=1>Temperature</option>
  <option value=2>Humidity</option>
  <option value=3>Light</option>
  <option value=4>Power</option>
  <option value=5>MQTT Client</option>
  <option value=6>Duty Cycle</option>
  <option value=7>Manual Operation</option>
  <option value=8>Remote Push Button</option>
</select>
&nbsp;<!--input type="text" id="ctrl_value_1" style="width:75px"--> &nbsp;
<br>

<span id="trigger_action_holder">
</span>

</div>


<br><br>
<input type="button" value="SAVE" onClick="save_setting()" style="width:100px"> <input type="button" style="width:100px" onClick="location.href = '/control_page.html';" value="CANCEL">
<br><br>
</body>
<script>
load_ctrl_action();
var program2load = getUrlParam('x','Empty');
var idprogram = getUrlParam('y','Empty');
console.log("loading program: " + program2load + " id:" + idprogram);
window.addEventListener('load', onLoad);
function onLoad(){
if(program2load != "new"){load_setting();}
}
//function to detect page param
function getUrlVars() {var vars = {};var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {vars[key] = value;});return vars;}
function getUrlParam(parameter, defaultvalue){var urlparameter = defaultvalue;if(window.location.href.indexOf(parameter) > -1){urlparameter = getUrlVars()[parameter];}return urlparameter;}

function toggle(input){
	var a = document.getElementById(input+"_en").checked;
	if(a){
		if(input == "on_time" || input == "off_time"){
		document.getElementById(input + "_container").innerHTML = '<input type="time" id="'+input+'_val">';
		}else{
		document.getElementById(input+"_container").innerHTML = '<input type="text" name="dateTimePicker" style="height:16px;display:inline" id='+input+'></span>';
		instance = new dtsel.DTS('input[id='+input+']',  {direction: 'BOTTOM',dateFormat: "yyyy-mm-dd", showTime: true,showDate: true});}
	}else{
		document.getElementById(input+"_container").innerHTML = '';
	}
}
function getEpoch(input){
	var d= new Date(input);
	a = d.getTime()/ 1000;
	return Number(a);
}

function toggle_day(){
	var a = '<input type="checkbox" id="sunday" > <label for="sunday"> sun </label>	<input type="checkbox" id="monday" > <label for="monday"> mon </label>';
	a += '<input type="checkbox" id="tuesday" > <label for="tuesday"> tue </label><input type="checkbox" id="wednesday" > <label for="wednesday"> wed </label>';
	a += '<input type="checkbox" id="thursday" > <label for="thursday"> thu </label><input type="checkbox" id="friday" > <label for="friday"> fri </label>'
	a += '<input type="checkbox" id="saturday" > <label for="saturday"> sat </label>';
	var b = document.getElementById("day_list_en").checked;
	if(b){
		document.getElementById("day_list_container").innerHTML = a;
	}else{
		document.getElementById("day_list_container").innerHTML = "";
	}
}

function toggle_cond(input, name){
	//detect trigger option
	var prim_opt = document.getElementById("ctrl_trigger").value;
	var div_add_condition = '<div style="margin-top:10px"><select id="sec_operator_'+name+'"> <option value=1>AND</option> <option value=2>OR</option></select>&nbsp; if &nbsp;';
	div_add_condition += '<select id="sec_trigger_'+name+'">';
	var array = ["Temperature", "Humidity", "Light", "Power"];
	for (i = 0 ; i < 4 ; i++){
	if( prim_opt != i+1){
	div_add_condition += '<option value='+(i+1)+'>'+array[i]+'</option>';
	}
	}
	div_add_condition += ' </select> &nbsp;<select id="sec_comp_'+name+'"><option value=1> ></option><option value=2> < </option></select>';
	div_add_condition += '&nbsp;<input type="text" id="sec_value_'+name+'" style="width:100px"></div>';
	var a = input.value;
	var holder = document.getElementById("sec_cond_"+name+"_holder");
	if(a == "Add Condition"){
		input.value = "Remove Condition";
		holder.innerHTML = div_add_condition;
	}else{
		input.value = "Add Condition";
		holder.innerHTML = "";
	}
}
function load_ctrl_action(){
	var action_A ="";
	action_A += '<table style="margin-top:10px"><td style="width:60px"><label class="switch"><input type="checkbox" id="switched_on" ><span class="slider round"></span>';
	action_A += '</label></td><td>Switched On</td></table>';
	action_A += '<div class="main_container" style="border:1px solid; padding:10px;border-radius:10px">	if Value <select id="action_A_cmpr_on">';
	action_A += '<option value=1> > </option><option value=2> < </option></select>&nbsp;';
	action_A += '<input type="text" id="action_A_value_on" style="width:100px"> <input id="add_cond_on" onClick="toggle_cond(this,'+"'on'"+')" type="button" style="float:right" value="Add Condition" ><br>';
	action_A +=  '<span id="sec_cond_on_holder"></span></div>';
	action_A += '<table style="margin-top:10px"><td style="width:60px"><label class="switch"><input type="checkbox" id="switched_off" ><span class="slider round"></span>';
	action_A += '</label></td><td>Switched Off</td></table>';
	action_A += '<div class="main_container" style="border:1px solid; padding:10px;border-radius:10px">	if Value <select id="action_A_cmpr_off">';
	action_A += '<option value=1> > </option><option value=2> < </option></select>&nbsp;';
	action_A += '<input type="text" id="action_A_value_off" style="width:100px"><input id="add_cond_off" onClick="toggle_cond(this,'+"'off'"+')" type="button" style="float:right" value="Add Condition" >';
	action_A += '<br><span id="sec_cond_off_holder"></span></div>';
	
	var action_B = '<div class="main_container" style="border:1px solid;border-radius:10px; padding:10px"><table><tr><td>Switch Device: </td><td>&nbsp;<label class="switch">';
	action_B += '<input type="checkbox" id="action_B_en"><span class="slider round"></span></label></td></tr></table></div></div>';
	
	var action_C = '<div class="main_container" style="border:1px solid; border-radius:10px; padding:10px"><div >Switch output on for: &nbsp; ';
	action_C += '<input type="checkbox" id="action_C_en_sec_on" onClick="toggle_field(this,'+"'action_C_sec_on"+ "'" +')">';
	action_C += '<input type="text" id="action_C_sec_on" class="greycolor" readOnly>';
	action_C += '<span id="action_C_sec_on_label" class="greyed_label">Sec</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_min_on" onClick="toggle_field(this,'+"'action_C_min_on'"+')"><input type="text" id="action_C_min_on" class="greycolor" readOnly>';
	action_C += '<span id="action_C_min_on_label" class="greyed_label">Min</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_hrs_on" onClick="toggle_field(this,'+"'action_C_hrs_on'"+')"><input type="text" id="action_C_hrs_on" class="greycolor" readOnly>';
	action_C += '<span id="action_C_hrs_on_label" class="greyed_label">Hrs</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_day_on" onClick="toggle_field(this,'+"'action_C_day_on'"+')"><input type="text" id="action_C_day_on" class="greycolor" readOnly>';
	action_C += '<span id="action_C_day_on_label" class="greyed_label">Day</span></div>';
	action_C += '<div style="margin-top:15px">Switch output off for: &nbsp; ';
	action_C += '<input type="checkbox" id="action_C_en_sec_off" onClick="toggle_field(this,'+"'action_C_sec_off'"+')">';
	action_C += '<input type="text" id="action_C_sec_off" class="greycolor" readOnly>';
	action_C += '<span id="action_C_sec_off_label" class="greyed_label">Sec</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_min_off" onClick="toggle_field(this,'+"'action_C_min_off'"+')">';
	action_C += '<input type="text" id="action_C_min_off" class="greycolor" readOnly>';
	action_C += '<span id="action_C_min_off_label" class="greyed_label">Min</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_hrs_off" onClick="toggle_field(this,'+"'action_C_hrs_off'"+ ')">';
	action_C += '<input type="text" id="action_C_hrs_off" class="greycolor" readOnly>';
	action_C += '<span id="action_C_hrs_off_label" class="greyed_label">Hrs</span>';
	action_C += '&nbsp;&nbsp;<input type="checkbox" id="action_C_en_day_off" onClick="toggle_field(this,'+"'action_C_day_off'"+')">';
	action_C += '<input type="text" id="action_C_day_off" class="greycolor" readOnly>';
	action_C += '<span id="action_C_day_off_label" class="greyed_label">Day</span></div>';
	action_C += '<div  style="margin-top:15px">';
	action_C += 'Initial state: &nbsp;<label class="switch"><input type="checkbox" id="action_C_init"><span class="slider round"></label></div>';
	action_C += '</div>';
	
	var action_D = '<div class="main_container" style="border:1px solid;border-radius:10px; padding:10px"><table><tr height="40px"><td>Initial State: </td><td>&nbsp;<label class="switch">';
	action_D += '<input type="checkbox" id="RPB_init_state"><span class="slider round"></span></label></td></tr><tr><td>Input Button: </td><td>';
	action_D += '<select id="input_remote"><option value=1> Relay A </option><option value= 2> Relay B</option><option value = 3> Remote PB </option></select></td></tr></table></div>';
	
	var selection = document.getElementById("ctrl_trigger").value;
	var el = document.getElementById("trigger_action_holder");
	if(selection >= 1 && selection <= 4){
		el.innerHTML = action_A;
		setInputFilter(document.getElementById("action_A_value_on"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
		setInputFilter(document.getElementById("action_A_value_off"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
	}else if( selection == 6){
		el.innerHTML = action_C;
		setInputFilter(document.getElementById("action_C_sec_on"), function(value) { return /^\d*$/.test(value); });
		setInputFilter(document.getElementById("action_C_min_on"), function(value) { return /^\d*$/.test(value); });
		setInputFilter(document.getElementById("action_C_hrs_on"), function(value) { return /^\d*$/.test(value); });
		setInputFilter(document.getElementById("action_C_day_on"), function(value) { return /^\d*$/.test(value); });
	}else if(selection == 7){
		el.innerHTML = action_B;
	}else if (selection == 8){
		el.innerHTML = action_D;
	}else{
		el.innerHTML = "";
	}
}


function toggle_field(input, action){
	var logic = input.checked;
	var RO_logic =true; var color ="grey";
	if(logic){RO_logic = false;	color = "black";}
	else{document.getElementById(action).value = "";}
	document.getElementById(action).readOnly = RO_logic;
	document.getElementById(action).style.color = color;
}

function day_list(){ 
	if(document.getElementById("day_list_en").checked){
	var day = document.getElementById("sunday").checked ? "1" : "0";
	day += document.getElementById("monday").checked ? "1" : "0";
	day += document.getElementById("tuesday").checked ? "1" : "0";
	day += document.getElementById("wednesday").checked ? "1" : "0";
	day += document.getElementById("thursday").checked ? "1" : "0";
	day += document.getElementById("friday").checked ? "1" : "0";
	day += document.getElementById("saturday").checked ? "1" : "0";
	return day;
	}else{
	return "";
	}
	
}
function save_setting(){
//checking 17.d
var d = document.getElementById("input_remote");
if( d != null){
	if(d.value == 1 || d.value == 2){
		if(d.value == document.getElementById("ctrl_out_opt").value){
			alert("input remote cannot be same with control output");
			return;
		}
	}
}

//checking 17.a
var a1 = document.getElementById("switched_on");var a2 = document.getElementById("switched_off");
if( a1 != null){
var a3 = document.getElementById("action_A_value_on"); var a4 = document.getElementById("sec_value_on");
if(a1.checked && a3.value == ""){ alert("required a value to be saved"); return;}
if(a1.checked && a4 != null){ if(a4.value == ""){ alert("required a value to be saved"); return;} }
}
if(a2 != null){
var a5 = document.getElementById("action_A_value_off"); var a6 = document.getElementById("sec_value_off");
if(a2.checked && a5.value == ""){ alert("required a value to be saved"); return;}
if(a2.checked && a6 != null){ if(a6.value == ""){ alert("required a value to be saved"); return;} }
}

//check 17.c
c =document.getElementById("ctrl_trigger").value;
if(c == 6){
var c1 = check_timed_cycle("on") < 60;
var c2 = check_timed_cycle("off") < 60;
if(c1 || c2){
alert("frequent switching of relays will shorten their life");
return;
}}

//check start date || end date
var e1 = document.getElementById("start_date");
var e2 = document.getElementById("end_date");
if(e1 != null && e2 != null){
	e1 = getEpoch(e1.value); e2 = getEpoch(e2.value);
    console.log(e1); console.log(e2);	
	if(e1 > e2){
		alert("end date must bigger than start date");
		return;
	}
}

if(program2load == "new"){ save_new(); } else {save_old();}
}



function build_save_json(old_json){
var a = document.getElementById("program_name").value;
old_json.name = (a == "") ? ("program"+idprogram) : a;
old_json.en = document.getElementById("program_en").checked;
old_json.start_date = (document.getElementById("start_date_en").checked) ? getEpoch(document.getElementById("start_date").value) : "";
old_json.end_date = (document.getElementById("end_date_en").checked) ? getEpoch(document.getElementById("end_date").value) : "";
old_json.days_active = day_list();
old_json.on_time_global =(document.getElementById("on_time_en").checked) ? (document.getElementById("on_time_val").value + "|" + make_day_epoch(document.getElementById("on_time_val").value)) : ("|-1");
old_json.off_time_global = (document.getElementById("off_time_en").checked) ? (document.getElementById("off_time_val").value + "|" + make_day_epoch(document.getElementById("off_time_val").value)) : ("|-1");
old_json.control_opt = document.getElementById("ctrl_out_opt").value;
var k = document.getElementById("ctrl_trigger").value;
old_json.control_trigger[0].option = k;

if(k >= 1 && k <= 4){
	var on_val = ((get_chkbox_val("switched_on") == 1) ? (document.getElementById("action_A_cmpr_on").value + "," + save2decimal(document.getElementById("action_A_value_on").value)) : "");
	var off_val = ((get_chkbox_val("switched_off") == 1)? (document.getElementById("action_A_cmpr_off").value + "," + save2decimal(document.getElementById("action_A_value_off").value)): "");
	if (document.getElementById("sec_cond_on_holder").innerHTML != "" && (get_chkbox_val("switched_on") == 1)){
		on_val += ((document.getElementById("sec_operator_on").value == 1) ? "&&" : "||") + document.getElementById("sec_trigger_on").value + ",";
		on_val += document.getElementById("sec_comp_on").value + "," + save2decimal(document.getElementById("sec_value_on").value);
	}
	if(document.getElementById("sec_cond_off_holder").innerHTML != "" && (get_chkbox_val("switched_off") == 1)){
		off_val += ((document.getElementById("sec_operator_off").value == 1) ? "&&" : "||") +  document.getElementById("sec_trigger_off").value + ",";
		off_val += document.getElementById("sec_comp_off").value + "," + save2decimal(document.getElementById("sec_value_off").value);
	}
	m = "on:" +on_val+"off:"+off_val;
}else if(k == 6){
	m = get_chkbox_val("action_C_en_sec_on") + "," + document.getElementById("action_C_sec_on").value + ",";
	m += get_chkbox_val("action_C_en_min_on") + "," + document.getElementById("action_C_min_on").value + ",";
	m += get_chkbox_val("action_C_en_hrs_on") + "," + document.getElementById("action_C_hrs_on").value + ",";
	m += get_chkbox_val("action_C_en_day_on") + "," + document.getElementById("action_C_day_on").value + ",";
	m += get_chkbox_val("action_C_en_sec_off") + "," + document.getElementById("action_C_sec_off").value + ",";
	m += get_chkbox_val("action_C_en_min_off") + "," + document.getElementById("action_C_min_off").value + ",";
	m += get_chkbox_val("action_C_en_hrs_off") + "," + document.getElementById("action_C_hrs_off").value + ",";
	m += get_chkbox_val("action_C_en_day_off") + "," + document.getElementById("action_C_day_off").value + ",";
	m += get_chkbox_val("action_C_init");
}else if(k == 7){
	m = String(get_chkbox_val("action_B_en"));
}else if(k == 8){
	m =  get_chkbox_val("RPB_init_state") + "," + document.getElementById("input_remote").value;
}
old_json.control_trigger[0].trigger_info = m;
return old_json;
}

function save_new(){
var old_json = {"id": idprogram, "name":"test 1", "en":false, "start_date": "", "end_date":"", "days_active": "", "on_time_global": "", "off_time_global":""
,"control_opt": "", "control_trigger":[{"option":1, "trigger_info":""}]};
old_json = build_save_json(old_json);
console.log(JSON.stringify(old_json));
var xhttp = new XMLHttpRequest();
xhttp.open("POST", "/rpc/FS.Put", true);
xhttp.setRequestHeader('Content-Type', 'application/json');
var string = window.btoa(JSON.stringify(old_json));
var contain = {"filename": "program"+idprogram+".json", "append":false, "data": string}
xhttp.send(JSON.stringify(contain));
xhttp.onload = function(){
	location.href = '/control_page.html';
}
}
function save_old(){
var old_json;
var xhr = new XMLHttpRequest();
xhr.open("POST", "/rpc/FS.Get", true);
xhr.setRequestHeader('Content-Type', 'application/json');
var comm = {"filename": program2load+".json"};
xhr.send(JSON.stringify(comm));
xhr.onload = function() {
	var data = JSON.parse(this.responseText);
	old_json = JSON.parse(window.atob(data.data));
	old_json = build_save_json(old_json);	
	var xhttp = new XMLHttpRequest();
	xhttp.open("POST", "/rpc/FS.Put", true);
	xhttp.setRequestHeader('Content-Type', 'application/json');
	var string = window.btoa(JSON.stringify(old_json));
	var contain = {"filename": program2load+".json", "append":false, "data": string}
	xhttp.send(JSON.stringify(contain));
	xhttp.onload = function(){
		location.href = '/control_page.html';
	}
	
}
}

function setInputFilter(textbox, inputFilter) {["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {textbox.addEventListener(event, function() {if (inputFilter(this.value)) {this.oldValue = this.value;this.oldSelectionStart = this.selectionStart;this.oldSelectionEnd = this.selectionEnd;} else if (this.hasOwnProperty("oldValue")) {this.value = this.oldValue;this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);} else {this.value = "";}});});}
function convert_epoch_from_time(input){return input.substring(0,2)*3600 + input.substring(3,5)*60;}
function save2decimal(input){input = String(input);var a = input.indexOf(".");if(a == -1){input += ".00";}else{	var b = input.substring(0, a+3);var c = input.substring(a+1,a+3).length;b += (c == 1) ? "0" : "";b += (c == 0) ? "00" : "";	input = b;}return input;}
function check_timed_cycle(name){
var array_name=["sec", "min", "hrs", "day"]; var ret = 0;
var array_time=[1, 60, 3600, 86400];
for (i = 0 ; i < 4; i++){
if(get_chkbox_val("action_C_en_"+array_name[i]+"_"+name) == 1){ ret += Number(document.getElementById("action_C_"+array_name[i]+"_"+name).value) * array_time[i];}
}
return ret;}
function make_day_epoch(h){ //h must string
  if(h == ""){ return -1;}
  var offset = new Date(); offset = offset.getTimezoneOffset()*60;
  var time_day = h.substring(0, h.indexOf(":"))* 3600;
  time_day += h.substring(h.indexOf(":")+1) * 60;
  time_day += offset;
  time_day = (time_day < 0)  ?  86400 + time_day: time_day;
  return time_day;
}

function get_chkbox_val(input){
var a = ((document.getElementById(input).checked==true) ? "1" : "0");
return a;
}
function load_setting(){
	var old_json;
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "/rpc/FS.Get", true);
	xhr.setRequestHeader('Content-Type', 'application/json');
	var comm = {"filename": program2load+".json"};
	xhr.send(JSON.stringify(comm));
	xhr.onload = function() {
		var data = JSON.parse(this.responseText);
		old_json = JSON.parse(window.atob(data.data));
		document.getElementById("program_name").value = old_json.name;
		document.getElementById("program_en").checked = old_json.en;
		if(old_json.start_date != ""){document.getElementById("start_date_en").checked = true; toggle("start_date"); document.getElementById("start_date").value = from_epoch(old_json.start_date);}
		if(old_json.end_date != ""){document.getElementById("end_date_en").checked = true; toggle("end_date"); document.getElementById("end_date").value = from_epoch(old_json.end_date);}
		if(old_json.days_active != ""){document.getElementById("day_list_en").checked = true; toggle_day();
		var day_list_str = old_json.days_active;
		document.getElementById("sunday").checked = (day_list_str[0] == 1  ? true: false);
		document.getElementById("monday").checked = (day_list_str[1] == 1  ? true: false);
		document.getElementById("tuesday").checked = (day_list_str[2] == 1  ? true: false);
		document.getElementById("wednesday").checked = (day_list_str[3] == 1  ? true: false);
		document.getElementById("thursday").checked = (day_list_str[4] == 1  ? true: false);
		document.getElementById("friday").checked = (day_list_str[5] == 1  ? true: false);
		document.getElementById("saturday").checked = (day_list_str[6] == 1  ? true: false);}
		var on_time = old_json.on_time_global;
		on_time = on_time.substring(0, on_time.indexOf("|"));
		var off_time = old_json.off_time_global;
		off_time = off_time.substring(0, off_time.indexOf("|"));
		if(old_json.on_time_global != "|-1"){document.getElementById("on_time_en").checked = true; toggle("on_time"); document.getElementById("on_time_val").value = on_time;}
		if(old_json.off_time_global != "|-1"){document.getElementById("off_time_en").checked = true; toggle("off_time"); document.getElementById("off_time_val").value = off_time;}
		document.getElementById("ctrl_out_opt").value = old_json.control_opt;
		var a= old_json.control_trigger[0].option;
		document.getElementById("ctrl_trigger").value = a;
		load_ctrl_action();
		var b= old_json.control_trigger[0].trigger_info;

			
		if(a >= 1 && a <= 4){
		var z = b.indexOf("on:");
		var y = b.indexOf("off:");
		var w = b.substring(z+3, y); //on value
		var v = b.substring(y+4);   //off value
		if(w != ""){
			var w1;
			if(w.indexOf("&&") != -1){
				w1 = w.indexOf("&&"); toggle_cond(document.getElementById("add_cond_on"), "on");	
				document.getElementById("sec_operator_on").value = 1;
			}else if(w.indexOf("||") != -1){
				w1 = w.indexOf("||"); toggle_cond(document.getElementById("add_cond_on"), "on");
				document.getElementById("sec_operator_on").value = 2;
			}else{
				w1 = -1;
			}
			document.getElementById("switched_on").checked = true;
			var com = w.indexOf(",");
			document.getElementById("action_A_cmpr_on").value = w.substring(0,com);
			document.getElementById("action_A_value_on").value = w.substring(com+1, w1);
			w = w.substring(w1+2);
			com = w.indexOf(",");
			document.getElementById("sec_trigger_on").value = (w.substring(0,com));
			com = w.indexOf(",", com)+1;
			com1 = w.indexOf(",",com);
			document.getElementById("sec_comp_on").value = (w.substring(com,com1)); 
			document.getElementById("sec_value_on").value = w.substring(com1+1);
		}
		if(v != ""){
			var v1;
			if(v.indexOf("&&") != -1){
				v1 = v.indexOf("&&"); toggle_cond(document.getElementById("add_cond_off"), "off");	
				document.getElementById("sec_operator_off").value = 1;
			}else if(v.indexOf("||") != -1){
				v1 = v.indexOf("||"); toggle_cond(document.getElementById("add_cond_off"), "off");
				document.getElementById("sec_operator_off").value = 2;
			}else{
				v1 = -1;
			}
			document.getElementById("switched_off").checked = true;
			var com = v.indexOf(",");
			document.getElementById("action_A_cmpr_off").value = v.substring(0,com);
			document.getElementById("action_A_value_off").value = v.substring(com+1, w1);
			v = v.substring(w1+2);
			com = v.indexOf(",");
			document.getElementById("sec_trigger_off").value = (v.substring(0,com));
			com = v.indexOf(",", com)+1;
			com1 = v.indexOf(",",com);
			document.getElementById("sec_comp_off").value = (v.substring(com,com1)); 
			document.getElementById("sec_value_off").value = v.substring(com1+1);
		}
		}else if(a == 6){
		apply_duty_cycle_conf(b);
		}else if(a == 7){
		document.getElementById("action_B_en").checked = Number(b) == 1 ? true: false;
		}else if(a == 8){
		document.getElementById("RPB_init_state").checked = ((b.substring(0, b.indexOf(",")) == 1) ? true : false);
		document.getElementById("input_remote").value = b.substring(b.indexOf(",") + 1, b.length);
		}
		
	}
}

function apply_duty_cycle_conf(input){
var array = ["sec_on", "min_on", "hrs_on", "day_on", "sec_off", "min_off", "hrs_off", "day_off"];
var index = 0;
var a = 0; var j= 0;
for (index = 0; index < 8; index++){
j = input.indexOf(",", a);
var logic = (input.substring(a, j) == "1")? true: false;
document.getElementById("action_C_en_" + array[index]).checked = logic; 
a = j+1; j = input.indexOf(",", a);
document.getElementById("action_C_" + array[index]).value = input.substring(a, j);
document.getElementById("action_C_" + array[index]).readOnly = !logic;
a = j+1;
}
document.getElementById("action_C_init").checked = (input.substring(a) == "1") ? true: false; 
}

function from_epoch(input){
	var d= new Date(input * 1000);
	return d.getFullYear() + "-" +(d.getMonth()+1) + "-" + d.getDate() + ", " + d.getHours()+":"+d.getMinutes() + ":" + d.getSeconds();
}

</script>
<style>
html{
	font-family: Arial; display: inline-block; text-align: center;
	-webkit-text-size-adjust:none;
}
.switch { position: relative; display: inline-block; width: 42px; height: 25px;}
.switch input { opacity: 0; width: 0; height: 0;}
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: red; -webkit-transition: .4s; transition: .4s;}
.slider:before { position: absolute; content: ""; height: 19px; width: 19px; left: 4px; bottom: 3px; background-color: white; -webkit-transition: .4s; transition: .4s;}
input:checked + .slider { background-color: #03b000;}
input:focus + .slider { box-shadow: 0 0 1px #2196F3;}
input:checked + .slider:before { -webkit-transform: translateX(15px); -ms-transform: translateX(15px); transform: translateX(15px);}
/* Rounded sliders */
.slider.round { border-radius: 34px;}
.slider.round:before { border-radius: 50%;}

.main_container{
	text-align:left; width:90%; margin-left:auto; margin-right:auto; margin-top:7px; margin-bottom:7px; display:inline-block; 
}

.greycolor{
	border:1px solid grey;
	width:30px;
}
.greyed_label{color:grey;}

#day_on_en:checked ~ #day_on_label{color:black;}
#day_off_en:checked ~ #day_off_label{color:black;}
#day_on_label, #day_off_label{ color:grey;}

#action_C_en_day_on:checked ~ #action_C_day_on_label{color:black;}
#action_C_en_hrs_on:checked ~ #action_C_hrs_on_label{color:black;}
#action_C_en_min_on:checked ~ #action_C_min_on_label{color:black;}
#action_C_en_sec_on:checked ~ #action_C_sec_on_label{color:black;}


#action_C_en_day_off:checked ~ #action_C_day_off_label{color:black;}
#action_C_en_hrs_off:checked ~ #action_C_hrs_off_label{color:black;}
#action_C_en_min_off:checked ~ #action_C_min_off_label{color:black;}
#action_C_en_sec_off:checked ~ #action_C_sec_off_label{color:black;}
</style>
</html>