<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title> Power Monitor Web Server | Setting</title>
	<link id="theme" rel="stylesheet" type="text/css" href="dark.css" />
	<link rel="stylesheet" type="text/css" href="general.css" />
<script>
load_conf();
function load_conf(){
var xhr = new XMLHttpRequest();
xhr.open("POST", "/rpc/FS.Get", true);
xhr.setRequestHeader('Content-Type', 'application/json');
var comm = {"filename": "setting.json"};
xhr.send(JSON.stringify(comm));
xhr.onload = function() {
var data = JSON.parse(this.responseText);
var old_json = JSON.parse(window.atob(data.data));
changetheme(old_json.theme);
}
}
function changetheme(input){
var sheets = document.getElementsByTagName('link');

if(input == 1){
sheets[0].href = "light.css";
document.getElementById("confirmation_box").style.backgroundColor = "white";
}else{
sheets[0].href = "dark.css";
document.getElementById("confirmation_box").style.backgroundColor = "black";
}
}
</script>
</head>
<body>
<div id="overlay" style="display:none;">
  <div id="confirmation_box" >
  <div id="circularG" >
	<div id="circularG_1" class="circularG"></div>
	<div id="circularG_2" class="circularG"></div>
	<div id="circularG_3" class="circularG"></div>
	<div id="circularG_4" class="circularG"></div>
	<div id="circularG_5" class="circularG"></div>
	<div id="circularG_6" class="circularG"></div>
	<div id="circularG_7" class="circularG"></div>
	<div id="circularG_8" class="circularG"></div>
  </div>
  <div style="margin-top:15px;font-size:20px" id="spinner_info"> Saving.. </div>
  <div style="margin-top:15px" id="failed_button"> 
  <input type="button" style="width:75px;font-size:16px" value="retry" onClick="save_conf()"> <input style="width:75px;font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>
  <div style="margin-top:15px" id="success_button">
  <input type="button" style="width:75px;font-size:16px" value="OK" onClick="off_overlay()"></div>
  </div>
</div>
<div id="main_div">
	<h1> Settings</h1>
	<h1> <a href="./">Home</a></h1>
	<div style="margin-top:10px; margin-bottom:20px" id="fw_version">
	FW VERSION
	</div>
	<div class="main_container">
	<b> Ethernet Enable </b><br>
	<label class="switch" style="margin-bottom:15px; margin-top:15px">
	<input type="checkbox" id="eth_en">
	<span class="slider round"></span>
	</label><br>
	<label for="mode" ><b>Default WiFi Mode:</b></label>
		<select name="mode" id="mode">
		<option value="1">Station</option>
		<option value="2">AP</option>
		<option value="3">Off</option>
	</select>
	<br><br>
	<input type="checkbox" id="pwr_sensor_check" name="pwr_sensor_check">	
	<label for="pwr_sensor_check"><b>Power Sensor Setting</b></label><br>
		&nbsp;&nbsp;&nbsp; on Development...
	<br>
	<input type="checkbox" id="LAN_conf" name="LAN_conf" onClick="LAN_conf()" style="margin-top:15px">	
	<label for="LAN_conf"><b>Static Eth IP</b></label><br>
	<table style="width:60%; padding-left:25px; margin-bottom:10px">
		<tr height="35px">
			<td width="35%">IP ADDRESS: </td>
			<td> <input style="width:92%" 	type = "text" id = "IP" class="input_textbox"  maxlength="15" readonly> </td>
		</tr>
		<tr height="35px">
			<td width="35%">GATEWAY ADDRESS: </td>
			<td > <input style="width:92%" type = "text" id = "GW" class="input_textbox" maxlength="15" readonly> </td>
		</tr>
		<tr height="35px">
			<td width="35%">SUBNET MASK: </td>
			<td > <input style="width:92%" type = "text" id = "SN" class="input_textbox" maxlength="15" readonly> </td>
		</tr>
	</table>
	<b>Set Time Zone</b>
	<br>
	<table width="400px">
	<tr >
		<td rowspan="2" style="width:50px">
			<input type="radio" id="pos_tz" name="mark_tz" value="+" checked>
			<label for="pos_tz">+</label><br>
			<input type="radio" id="neg_tz" name="mark_tz" value="-">
			<label for="neg_tz">-</label>
		</td>
	</tr>
	<tr>
		<td style="width:80px">
		<input type = "number" style="width:50px; font-size:20px" min="0" max="12" id="hour" placeholder="hh"> 
		<span style="font-size:20px"> &nbsp;: </span>
		</td>
		<td style="width:80px">
			<input type = "number" style="width:50px; font-size:20px" min="0" max="59" id="minute" placeholder="mm">
		</td>
		<td >
			<input type="button" style="text-align:center" value="Pull from Browser" onClick="auto_tz()">
		</td>
	</tr>
	</table>
	<br>
	<div style="display:block">
	<b>Temperature Scale:</b>
	<br>
	<input type="radio" id="temp_C" name="temp" value="1" checked>
	<label for="temp_C">C</label><br>
	<input type="radio" id="temp_F" name="temp" value="2">
	<label for="temp_F">F</label><br><br>
	</div>
	<div style="display:block">
	<b>Page Theme:</b>
	<br>
	<input type="radio" id="light_theme" name="theme" value="1" checked onChange="changetheme(1)">
	<label for="light_theme">Light</label><br>
	<input type="radio" id="dark_theme" name="theme" value="2" onChange="changetheme(2)">
	<label for="dark_theme">Dark</label><br><br>
	<b> Decimal places (logging): </b>
	<select id="dec_place"> <option value=0 >0</option><option value=1> 1 </option> <option value=2> 2</option></select>
	<br><br>
	<b>  <abbr title="Allow secondary outputs to be used" style="cursor:help">Dev Mode</abbr></b><br>
	<label class="switch" style="margin-bottom:15px; margin-top:15px">
	<input type="checkbox" id="dev_mode_en">
	<span class="slider round"></span>
	</label><br>
	</div>
	<b>Panel LED Brightness</b><br>
	<input type="range" min="0" max="255" value="25" class="sliding_range" id="panel_brightness"><br>
	<b>Remote LED Brightness</b><br>
	<input type="range" min="0" max="255" value="25" class="sliding_range" id="remote_brightness">
	<br><br>
	<b>Web OTA</b>
	<br>
	<form id="uploadform" enctype="multipart/form-data" method="POST" action="#">
	<input type="file" name="file" id="file" style="margin-top:10px" accept=".zip" required ><br>
	<input type= "submit" value="UPDATE" style="width:120px;margin-top:10px" id="update_file">
	</form>
	
	<div id="progress_holder" style="border-radius:10px;"></div>
	</div>
	<input type="button" value="SAVE" onClick="save_conf()">
	<br><br>
	<input type="button" value="Reboot" onClick="reboot()">
	<br>

	
</div>
</body>

<script>
	
	window.addEventListener('load', onLoad);	
	function onLoad(){
		console.log("DOM loaded");
		load_conf();
		fetch_version();
	}
	function LAN_conf(){
		var logic = document.getElementById("LAN_conf").checked;
		if(logic){
			document.getElementById("IP").readOnly = false;
			document.getElementById("GW").readOnly = false;
			document.getElementById("SN").readOnly = false;
		}else{
			document.getElementById("IP").readOnly = false;
			document.getElementById("GW").readOnly = false;
			document.getElementById("SN").readOnly = false;
		}
	}
	
	function ValidateIPaddress(ipaddress) {  
	  if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipaddress)) {  
		return (true)  
	  }  
	  alert("You have entered an invalid IP address!")  
	  return (false)  
	} 
	function load_conf(){
		var old_json;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/FS.Get", true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		var comm = {"filename": "setting.json"};
		xhr.send(JSON.stringify(comm));
		xhr.onload = function() {
			var data = JSON.parse(this.responseText);
			old_json = JSON.parse(window.atob(data.data));
			document.getElementById("eth_en").checked = old_json.eth_en;
			if(old_json.eth_en){
				getconfig();
			}
			document.getElementById("dev_mode_en").checked = old_json.dev_mode;
			document.getElementById("mode").value = old_json.wifi[0].mode;
			document.getElementById("pwr_sensor_check").checked = old_json.pwr_sensor[0].enable;
			var static_conf = old_json.static_IP_conf[0].enable;
			if(static_conf){
				document.getElementById("LAN_conf").checked = true;
				document.getElementById("IP").value = old_json.static_IP_conf[0].IP;
				document.getElementById("GW").value = old_json.static_IP_conf[0].GW;
				document.getElementById("SN").value = old_json.static_IP_conf[0].SN;
				document.getElementById("IP").readOnly = false;
				document.getElementById("GW").readOnly = false;
				document.getElementById("SN").readOnly = false;
			}
			var time_zone = old_json.timezone;
			if(time_zone <0){
				document.getElementById("neg_tz").checked = true;
				time_zone = Math.abs(time_zone);
			}
			var hour = Math.floor(time_zone/3600);
			var minute = time_zone - hour*3600; 
			minute /= 60;
			document.getElementById("hour").value = hour;
			document.getElementById("minute").value = minute;
			var temp = old_json.temp_scale;
			if(temp == 2){
				document.getElementById("temp_F").checked = true;
			}
			document.getElementById("dec_place").value = old_json.dec_place;
			var theme = old_json.theme;
			if(theme == 2){
				document.getElementById("dark_theme").checked = true;
			}			
			document.getElementById("remote_brightness").value = old_json.brightness[0].remote;
			document.getElementById("panel_brightness").value = old_json.brightness[0].panel;
		}
	}
	function auto_tz(){
		var d = new Date();
		var offset = d.getTimezoneOffset();
		if(offset < 0){//positive
			document.getElementById("pos_tz").checked = true;
		}else{
			document.getElementById("neg_tz").checked = true;
		}
		offset = Math.abs(offset);
		var hour = Math.floor(offset/60);
		document.getElementById("hour").value = hour;
		var minute = offset - hour*60;
		document.getElementById("minute").value = minute;
	}
	function save_conf(){
		var old_json;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/FS.Get", true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		var comm = {"filename": "setting.json"};
		xhr.send(JSON.stringify(comm));
		on_overlay();
		document.getElementById("circularG").style.display = 'block';
		document.getElementById("success_button").style.display="none";
		document.getElementById("failed_button").style.display="none";
		document.getElementById("spinner_info").innerHTML = "Saving..";
		xhr.onreadystatechange = function() {
		if (xhr.readyState == 4 && xhr.status == 200)  {
			var data = JSON.parse(this.responseText);
			old_json = JSON.parse(window.atob(data.data));
			var mode = document.getElementById("mode").value;
			var network_conf = document.getElementById("mode").value;
			var pwr_sensor_en = document.getElementById("pwr_sensor_check").checked;
			var net_conf_en = document.getElementById("LAN_conf").checked;
			var IP ="";var GW ="";var SN ="" ;
			if(net_conf_en){
				IP = document.getElementById("IP").value;
				GW = document.getElementById("GW").value;
				SN = document.getElementById("SN").value;
				if(!ValidateIPaddress(IP)){return;}
				if(!ValidateIPaddress(GW)){return;}
				if(!ValidateIPaddress(SN)){return;}
			}
			var mark_tz = (document.getElementById("pos_tz").checked ? 1 : -1);
			var hour = document.getElementById("hour").value;
			var minute = document.getElementById("minute").value;
			if(hour == "" || minute==""){
				alert("time zone must not empty");
				return;
			}
			if(!(hour >= 0 && hour <= 12)){
				alert("invalid hour value ( 0 to 12)");
				return;
			}
			if(!(minute >= 0 && minute <= 59)){
				alert("invalid minute value (0 to 59)");
				return;
			}
			var time_zone = ((hour * 3600) + (minute * 60)) * mark_tz;
			var temp_mode = (document.getElementById("temp_C").checked ? 1 : 2);
			var theme_mode = (document.getElementById("light_theme").checked? 1 : 2);
			old_json.eth_en = document.getElementById("eth_en").checked;
			old_json.wifi[0].mode = mode;
			old_json.pwr_sensor[0].enable = pwr_sensor_en;
			old_json.static_IP_conf[0].enable = net_conf_en;
			old_json.static_IP_conf[0].IP = IP;
			old_json.static_IP_conf[0].GW = GW;
			old_json.static_IP_conf[0].SN = SN;
			old_json.dev_mode = document.getElementById("dev_mode_en").checked;
			if(!old_json.dev_mode){
			old_json.ctrl_page.LED = 0;
			old_json.ctrl_page.LED_prog = 0;
			old_json.ctrl_page.IO14 = false;
			}
			old_json.timezone = time_zone;
			old_json.temp_scale = temp_mode;
			old_json.theme = theme_mode;
			old_json.dec_place = document.getElementById("dec_place").value;
			old_json.brightness[0].panel = document.getElementById("panel_brightness").value;
			old_json.brightness[0].remote = document.getElementById("remote_brightness").value;
			var xhttp = new XMLHttpRequest();
			xhttp.open("POST", "/rpc/FS.Put", true);
			xhttp.setRequestHeader('Content-Type', 'application/json');
			var string = window.btoa(JSON.stringify(old_json));
			var contain = {"filename": "setting.json", "append":false, "data": string}
			xhttp.send(JSON.stringify(contain));
			xhttp.onreadystatechange = function() {
				if (xhttp.readyState === 4 && xhttp.status == 200)  {
			//	window.open("program_editor.html?x=program"+idprogram +"&y=" +idprogram +"&"+Math.random() * Math.random(), "_self");
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = "Configuration Saved"
				document.getElementById("success_button").style.display="block";
				document.getElementById("failed_button").style.display="none";
				}else if(xhttp.readyState == 4 && xhttp.status != 200){
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = "Device does not respond!";
				document.getElementById("success_button").style.display="none";
				document.getElementById("failed_button").style.display="block";
				return;
				}
			}//xhttp readystate	
			save_eth_conf(old_json.eth_en, IP, GW, SN);	
			var xhttp2 = new XMLHttpRequest();
			xhttp2.open("POST", "/rpc/setting", true);
			xhttp2.send();
		}else if(xhr.readyState == 4 && xhr.status != 200){
			document.getElementById("circularG").style.display = 'none';
			document.getElementById("spinner_info").innerHTML = "Device does not respond!";
			document.getElementById("success_button").style.display="none";
			document.getElementById("failed_button").style.display="block";
		}
		}//xhr readystate
	}//save conf function
	function save_eth_conf(en, ip, gw, netmask){
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/rpc/Config.Set", true);
		xhttp.setRequestHeader('Content-Type', 'application/json');
		var contain = {"config": {"eth": {"enable": en, "ip": ip, "gw": gw, "netmask":netmask}}};
		xhttp.send(JSON.stringify(contain));
	}
	function reboot(){
		var con = confirm("Proceed to reboot?");
		if(con){
			var xhr = new XMLHttpRequest();
			xhr.open("POST", "/rpc/Sys.Reboot", true);
			xhr.send();
		}
	}
	function getconfig(){
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/rpc/Sys.GetInfo", true);
		xhttp.send();
		xhttp.onload = function(){
			var response = JSON.parse(this.responseText);
			document.getElementById("IP").value = response.eth.ip;
			
		}
	}
	function fetch_version(){
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/rpc/Sys.GetInfo", true);
		xhttp.send();
		xhttp.onload = function(){
			var response = JSON.parse(this.responseText);
			document.getElementById("fw_version").innerHTML = "<b>FW version: " + response.fw_version + "</b>";
		}
	}
function on_overlay() {
  document.getElementById("overlay").style.display = "block";
  document.getElementById("main_div").style.filter = "blur(2px)";
  document.getElementById("overlay").style.filter = "none";
}

function off_overlay() {
  document.getElementById("overlay").style.display = "none";
  document.getElementById("main_div").style.filter = "none";
}
//ota
const form = document.querySelector("#uploadform");
form.addEventListener("submit", e => {
	
	document.getElementById("progress_holder").innerHTML = '<div id="myProgress"><div id="myBar"></div>	</div><div id="status">0%</div>';
	e.preventDefault();
	var files = document.querySelector("[id=file]").files[0];
	var data = new FormData();
	data.append("update", files);
	console.log(data);
	var xhr = new XMLHttpRequest();
	xhr.upload.onprogress = function(evt){
		if(evt.lengthComputable){
			var per = evt.loaded/evt.total;
			var percentval = Math.round(per*100) + '%';
			document.getElementById("status").innerHTML = percentval;
			document.getElementById("myBar").style.width = percentval;
		}
	};
	xhr.onloadend = function (e) {
		document.getElementById("status").innerHTML = "file uploaded";
		console.log("end");
	}
	xhr.addEventListener("error", function(e){
		document.getElementById("status").innerHTML = "uploading error";
	});
	xhr.open("POST", "/update");
	xhr.send(data);
});
</script>

<style>
	html{
		font-family: Arial; display: inline-block; text-align: center;
		-webkit-text-size-adjust:none;
	}
	.main_container{
		width:90%; 
		text-align:left;  
		padding-top:15px;
		margin-left:auto; 
		margin-right:auto
	}
	.switch { position: relative; display: inline-block; width: 42px; height: 25px;}
	.switch input { opacity: 0; width: 0; height: 0;}
	.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: red; -webkit-transition: .4s; transition: .4s;}
	.slider:before { position: absolute; content: ""; height: 19px; width: 19px; left: 4px; bottom: 3px; background-color: white; -webkit-transition: .4s; transition: .4s;}
	input:checked + .slider { background-color: #03b000;}
	input:focus + .slider { box-shadow: 0 0 1px #2196F3;}
	input:checked + .slider:before { -webkit-transform: translateX(15px); -ms-transform: translateX(15px); transform: translateX(15px);}
	/* Rounded sliders */
	.slider.round { border-radius: 34px;}
	.slider.round:before { border-radius: 50%;}
	
	.sliding_range {
		-webkit-appearance: none;
		width: 50%;
		height: 15px;
		border-radius: 5px;  
		background: #d3d3d3;
		outline: none;
		opacity: 0.7;
		margin-top:15px;
		margin-bottom:15px;
		-webkit-transition: .2s;
		transition: opacity .2s;
	}

	.sliding_range:hover {
	  opacity: 1;
	}

	.sliding_range::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 25px;
		height: 25px;
		border-radius: 50%;
		background: #4CAF50;
		cursor: pointer;
	}

.sliding_range::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: #4CAF50;
  cursor: pointer;
}
#myProgress {
width: 95%;
background-color: #ddd;
margin-top:10px;
margin-left:auto;
border-radius:10px;
margin-right:auto;
}

#myBar {
width: 0%;
height: 15px;
border-radius:10px;
background-color: #4CAF50;
}
#status{
text-align:center;
}
</style>
</html>