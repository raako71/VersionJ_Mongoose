<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title>Socket Controller Settings</title>
	<link id="theme" rel="stylesheet" type="text/css" href="dark.css?v0.10.7"/>
	<link rel="stylesheet" type="text/css" href="general.css?v0.10.7"/>
	<script src="./login.js.gz?v0.10.7" defer></script>
</head>
<body>
<div id="overlay_time_setting" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="time_setting_box">
</div>
</div>
<div id="overlay_save" class="overlay" style="display:none;z-index:3;">
  <div class="confirmation_box" >
  <div id="circularG" >
	<div id="circularG_1" class="circularG"></div>
	<div id="circularG_2" class="circularG"></div>
	<div id="circularG_3" class="circularG"></div>
	<div id="circularG_4" class="circularG"></div>
	<div id="circularG_5" class="circularG"></div>
	<div id="circularG_6" class="circularG"></div>
	<div id="circularG_7" class="circularG"></div>
	<div id="circularG_8" class="circularG"></div>
  </div>
  <div style="margin-top:30px;font-size:20px" id="spinner_info"> Saving.. </div>
  <div class="invsi_button" id="failed_button"> 
  <input type="button" style="font-size:16px" value="retry" onClick="save_conf()"> <input style="font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>
  <div class="invsi_button" id="success_button">
  <input type="button" style="font-size:16px" value="OK" onClick="off_overlay();load_conf();"></div>
  <div class="invsi_button" id="relogin_button">
  <input type="button" style="font-size:16px;" value="OK" onClick="off_overlay();on_overlay_login(2);"></div>
  <div class="invsi_button" id="refresh_button">
  <input type="button" style="font-size:16px;" value="refresh" onClick="off_overlay();window.location.reload(true);"> <input style="font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>
  </div>
</div>
<div id="overlay_wifi" class="overlay" style="display:none;font-size:16px">
  <div class="confirmation_box">
	<b>Add New WiFi Access Point</b><br>
	<div id="scan_result" style="margin-top:10px;margin-bottom:10px;padding-left:10%;padding-right:10%;text-align:left">
	</div>
	<input type="button" value="scan" id="scan_wifi" onClick="scan_wifi()"><br>
	<div style="text-align:left;padding-left:10%; padding-right:10%;margin-top:10px">
	SSID: <input type="text" style="width:80%; margin-bottom:5px" id="wifi_ssid"><br>
	Key :&nbsp;&nbsp;<input type="password" style="width:80%;margin-left:1px;" id="wifi_pass">
	</div>
	<span style="margin-top:10px;display:block;" id="wifi_warning"></span>
	<div style="margin:15px">
	<input type="button" onClick="this.value=='save' ? connect_wifi() : off_overlay_wifi()" id="save_wifi" value="save"><input id="cancel_wifi" type="button" value="cancel" onClick="off_overlay_wifi()">
	</div>
  </div>
</div>
<!--overlay login-->
<div id="overlay_login" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="multipurpose">
</div>
</div>

<div id="overlay_change_pass" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box">
<b>Change Password</b><br>
<div style="text-align:left;padding-left:10%; padding-right:10%;margin-top:10px">
<span id="old_password_holder">Existing Password: <input type="password" style="width:100%; margin-bottom:5px" id="old_password"></span><br>
New Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass1"><br>
Confirm Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass2"><br>
</div>
<span style="margin-top:10px;display:block;" id="change_pass_warning"></span>
<div style="margin-top:10px">
<input type="button" id="confirm_change_password" onClick="change_pass_info()" value="OK"><input id="cancel_change_password" type="button" value="CANCEL" onClick="off_overlay_change_pass();on_overlay_login(2)">
</div>
</div> 
</div>
<!--eof overlay login-->
<div id="main_div">
<div class="top_panel">
<span style="float:left;margin-left:25px;padding:5px" id="clock_info">
</span>
<span style="float:right;margin-right:25px;padding:5px;">
<span id='log_info'>Logged in</span>
<span class='dropdown'><input type="button" class="dropbtn" style="margin-left:25px" value = "menu">
<div class="dropdown-content">
    <a href="/index.html.gz?v0.10.7">Home</a>
	<a href="/graph.html.gz?v0.10.7">Graph</a>
    <a href="/control_page.html.gz?v0.10.7">Control Logic</a>
    <a href="/setting.html.gz?v0.10.7">Settings</a>
	<a href="javascript:void(0)" id="log_button" onClick='login_confirm(this)'>Login</a>
 </div>
 </span>
</span>
</div>

<h1>Socket Controller Settings</h1>

<div class="main_container">
	<div class="section">
		<label for="mode" ><b>Default WiFi Mode:</b></label>
		<select name="mode" id="mode">
			<option value="1">Station</option>
			<option value="2">AP</option>
			<option value="4">STA+AP</option>
			<option value="3">Off</option>
		</select>
		<br><br>
		<div id="wifi_info0"></div>
		<div id="wifi_info1"></div>
		<b> Saved WiFi Networks</b>
		<br>
		<span id="wifi_saved_list"></span>
		<input style="margin-top:10px; margin-bottom:10px" type="button" value="Add New WiFi Network" onClick="on_overlay_wifi()">
		<br>
	</div>
			
	<div class="section">
		<b> Enable Ethernet </b><br>
		<label class="switch" style="margin: 15px 0">
			<input type="checkbox" id="eth_en">
			<span class="slider round"></span>
		</label><br>
		<input type="checkbox" id="LAN_conf" name="LAN_conf" onClick="LAN_conf()" style="margin-top:15px">	
		<label for="LAN_conf"><b>Static Eth IP</b></label><br>
		<table >
			<tr height="35px">
				<td width="35%">IP ADDRESS: </td>
				<td> <input style="width:92%" 	type = "text" id = "IP" class="input_textbox"  maxlength="15" readonly> </td>
			</tr>
			<tr height="35px">
				<td width="35%">GATEWAY ADDRESS: </td>
				<td > <input style="width:92%" type = "text" id = "GW" class="input_textbox" maxlength="15" readonly> </td>
			</tr>
			<tr height="35px">
				<td width="35%">SUBNET MASK: </td>
				<td > <input style="width:92%" type = "text" id = "SN" class="input_textbox" maxlength="15" readonly> </td>
			</tr>
		</table>
	</div>
	<div class="section">
	<b> Enable Remote Sensors</b><br>
		<label class="switch" style="margin: 10px 0">
		<input type="checkbox" id="i2c_en">
		<span class="slider round"></span>
	</label><br>
	</div>
	<!--div class="section">
		<input type="checkbox" id="pwr_sensor_check" name="pwr_sensor_check">	
		<label for="pwr_sensor_check"><b>Power Sensor Setting</b></label><br>
		&nbsp;&nbsp;&nbsp; in Development...
		<br>
	</div-->
	<div class="section">
		<b>Set Time Zone</b>
		<br>
		<table width="250px" style="float: left;">
			<tr >
				<td rowspan="2" style="width:50px">
					<input type="radio" id="pos_tz" name="mark_tz" value="+" checked>
					<label for="pos_tz">+</label><br>
					<input type="radio" id="neg_tz" name="mark_tz" value="-">
					<label for="neg_tz">-</label>
				</td>

				<td style="width:50px">
					<input type = "number" style="width:50px; font-size:20px" min="0" max="12" id="hour" placeholder="hh"> 
					<span style="font-size:20px"> &nbsp;: </span>
				</td>
				<td style="width:50px">
					<input type = "number" style="width:50px; font-size:20px" min="0" max="59" id="minute" placeholder="mm">
				</td>

			</tr>
		</table>
		<input type="button" style="margin-top: 15px;" value="Pull from Browser" onClick="auto_tz()">
		<div style="clear: both"></div>
	</div>

	<div class="section">
		<b>Temperature Scale:</b>
		<br>
		<input type="radio" id="temp_C" name="temp" value="1" checked>
		<label for="temp_C">C</label><br>
		<input type="radio" id="temp_F" name="temp" value="2">
		<label for="temp_F">F</label><br><br>
	</div>
	<div class="section">
		<b>Page Theme:</b>
		<br>
		<input type="radio" id="light_theme" name="theme" value="1" checked onChange="changetheme(1)">
		<label for="light_theme">Light</label><br>
		<input type="radio" id="dark_theme" name="theme" value="2" onChange="changetheme(2)">
		<label for="dark_theme">Dark</label><br><br>
	</div>
	<div class="section">
		<b> Decimal places (logging): </b>
		<select id="dec_place"> <option value=0 >0</option><option value=1> 1 </option> <option value=2> 2</option></select>
		<br><br>
	</div>
	<div class="section">
		<b>  <abbr title="Allow secondary outputs to be used" style="cursor:help">Dev Mode</abbr></b><br>
		<label class="switch" style="margin: 15px 0">
			<input type="checkbox" id="dev_mode_en">
			<span class="slider round"></span>
		</label><br>
	</div>
	<div class="section">
		<b>Panel LED Brightness</b><br>
		<input type="range" min="0" max="255" value="25" class="sliding_range" id="panel_brightness"><br>
		<b>Remote LED Brightness</b><br>
		<input type="range" min="0" max="255" value="25" class="sliding_range" id="remote_brightness">
	</div>
	<div class="section">
		<b>Web Firmware Update</b>
		<br>
		<form id="uploadform" enctype="multipart/form-data" method="POST" action="#">
			<input type="file" name="file" id="file" style="margin-top:10px" accept=".zip" required ><br>
			<input type= "submit" style="display:none" id="update_file" >
		</form>
		<input type= "button" value="UPDATE" style="width:120px;margin-top:10px" onClick="upload_fw()">

		<div id="progress_holder" style="border-radius:10px;"></div>
	</div>
	<div class="section" style="margin-top:20px; margin-bottom:10px" id="fw_version"> Build Version </div>
	
</div>
<input type="button" style="margin: 15px auto;" value="SAVE" onClick="save_conf()">

<input type="button" value="Reboot" onClick="reboot()">
<br>

</div>
</body>

<script>
	window.addEventListener('load', onLoad);	
	var sys_info ="";
	fetch_version();
	function onLoad(){
		console.log("DOM loaded");
		load_conf();	
		update_time();
		setInterval(update_time, 1000);		
	}
	function LAN_conf(){
		var logic = document.getElementById("LAN_conf").checked;
		if(logic){
			document.getElementById("IP").readOnly = false;
			document.getElementById("GW").readOnly = false;
			document.getElementById("SN").readOnly = false;
		}else{
			document.getElementById("IP").readOnly = false;
			document.getElementById("GW").readOnly = false;
			document.getElementById("SN").readOnly = false;
		}
	}
	
	function ValidateIPaddress(ipaddress) {  
	  if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipaddress)) {  
		return (true)  
	  }  
	  alert("You have entered an invalid IP address!")  
	  return (false)  
	} 
	function load_conf(){
		var old_json;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/FS.Get", true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		var comm = {"filename": "setting.json"};
		xhr.send(JSON.stringify(comm));
		xhr.onload = function() {
			var data = JSON.parse(this.responseText);
			old_json = JSON.parse(window.atob(data.data));
			document.getElementById("eth_en").checked = old_json.eth_en;
			document.getElementById("i2c_en").checked = old_json.i2c_en;
			if(old_json.eth_en){
				getconfig();
			}
			document.getElementById("dev_mode_en").checked = old_json.dev_mode;
			document.getElementById("mode").value = old_json.wifi.mode;
			build_wifi_saved_list(old_json.wifi.cfg);
			//document.getElementById("pwr_sensor_check").checked = old_json.pwr_sensor[0].enable;
			var static_conf = old_json.static_IP_conf[0].enable;
			if(static_conf){
				document.getElementById("LAN_conf").checked = true;
				document.getElementById("IP").value = old_json.static_IP_conf[0].IP;
				document.getElementById("GW").value = old_json.static_IP_conf[0].GW;
				document.getElementById("SN").value = old_json.static_IP_conf[0].SN;
				document.getElementById("IP").readOnly = false;
				document.getElementById("GW").readOnly = false;
				document.getElementById("SN").readOnly = false;
			}
			var time_zone = old_json.timezone;
			if(time_zone <0){
				document.getElementById("neg_tz").checked = true;
				time_zone = Math.abs(time_zone);
			}
			var hour = Math.floor(time_zone/3600);
			var minute = time_zone - hour*3600; 
			minute /= 60;
			document.getElementById("hour").value = hour;
			document.getElementById("minute").value = minute;
			var temp = old_json.temp_scale;
			if(temp == 2){
				document.getElementById("temp_F").checked = true;
			}
			document.getElementById("dec_place").value = old_json.dec_place;
			var theme = old_json.theme;
			if(theme == 2){
				document.getElementById("dark_theme").checked = true;
			}			
			document.getElementById("remote_brightness").value = old_json.brightness[0].remote;
			document.getElementById("panel_brightness").value = old_json.brightness[0].panel;
			fetch_wifi_status();
		}
	}
	function auto_tz(){
		var d = new Date();
		var offset = d.getTimezoneOffset();
		if(offset < 0){//positive
			document.getElementById("pos_tz").checked = true;
		}else{
			document.getElementById("neg_tz").checked = true;
		}
		offset = Math.abs(offset);
		var hour = Math.floor(offset/60);
		document.getElementById("hour").value = hour;
		var minute = offset - hour*60;
		document.getElementById("minute").value = minute;
	}
	function save_conf(){
		
		//validate cookie
		var mark_tz = (document.getElementById("pos_tz").checked ? 1 : -1);
		var hour = document.getElementById("hour").value;
		var minute = document.getElementById("minute").value;
		if(hour == "" || minute==""){alert("time zone must not empty"); off_overlay(); return;}
		if(!(hour >= 0 && hour <= 12)){alert("invalid hour value ( 0 to 12)"); off_overlay(); return;}
		if(!(minute >= 0 && minute <= 59)){alert("invalid minute value (0 to 59)"); off_overlay();return;}
		if(document.getElementById("LAN_conf").checked){		
			if(!ValidateIPaddress(document.getElementById("IP").value)){return;}
			if(!ValidateIPaddress(document.getElementById("GW").value)){return;}
			if(!ValidateIPaddress(document.getElementById("SN").value)){return;}
		}
		var old_json;
		if(!check_password()){
			save_command = true;
			on_overlay_login(2);
			return;
		}
		on_overlay();
		document.getElementById("circularG").style.display = 'block';
		document.getElementById("spinner_info").innerHTML = "Saving..";
		validate_cookie(function(i){
			if(i.code == 200 && i.data.status == "illegal"){
				save_command = true;
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = "Session end, please re-login!";
				document.getElementById("relogin_button").style.display="block";
				return;
			}else if(i.code != 200){
				save_command = true;
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = i.status;
				document.getElementById("failed_button").style.display="block";
				return;
			}
		xhr_send("FS.get", JSON.stringify({filename:"setting.json"}), function(i){
			if(i.status != "success"){
			document.getElementById("circularG").style.display = 'none';
			document.getElementById("spinner_info").innerHTML = i.status;
			document.getElementById("failed_button").style.display="block";
			return;
			}
			old_json = JSON.parse(window.atob(i.data.data));
			var mode = document.getElementById("mode").value;
			var network_conf = document.getElementById("mode").value;
			//var pwr_sensor_en = document.getElementById("pwr_sensor_check").checked;
			var net_conf_en = document.getElementById("LAN_conf").checked;
			var IP ="";var GW ="";var SN ="" ;
			if(net_conf_en){IP = document.getElementById("IP").value;GW = document.getElementById("GW").value;SN = document.getElementById("SN").value;}
			var time_zone = ((hour * 3600) + (minute * 60)) * mark_tz;
			var temp_mode = (document.getElementById("temp_C").checked ? 1 : 2);
			var theme_mode = (document.getElementById("light_theme").checked? 1 : 2);
			old_json.eth_en = document.getElementById("eth_en").checked;
			old_json.i2c_en = document.getElementById("i2c_en").checked;
			old_json.wifi.mode = mode;
			//old_json.pwr_sensor[0].enable = pwr_sensor_en;
			old_json.static_IP_conf[0].enable = net_conf_en;
			old_json.static_IP_conf[0].IP = IP;
			old_json.static_IP_conf[0].GW = GW;
			old_json.static_IP_conf[0].SN = SN;
			var dev_mode = document.getElementById("dev_mode_en").checked;
			if(old_json.dev_mode && !dev_mode && old_json.ctrl_page.LED == 1){old_json.ctrl_page.LED = 0;}
			if(old_json.dev_mode && !dev_mode){ //reset input D
				for(i=0; i<4; i++){
				old_json.override[i].sensor = true;
				old_json.override[i].output_ovr = false;
				old_json.override[i].ovr_limit = 0;
				old_json.override[i].ovr_act = 0;
				old_json.override[i].output_opt = 0;
				old_json.override[i].mode = 1;
				}
			}
			if(!old_json.dev_mode){old_json.ctrl_page.IO14 = false;}
			old_json.dev_mode = dev_mode;
			old_json.timezone = time_zone;
			old_json.temp_scale = temp_mode;
			old_json.theme = theme_mode;
			old_json.dec_place = document.getElementById("dec_place").value;
			old_json.brightness[0].panel = document.getElementById("panel_brightness").value;
			old_json.brightness[0].remote = document.getElementById("remote_brightness").value;
			//check deleted save network_conf
			for (var i = 0; i < 3 ; i++){if(document.getElementById("wifi_saved"+i) != null){if(document.getElementById("wifi_saved"+i).checked){old_json.wifi.cfg[i].ssid = "";old_json.wifi.cfg[i].pass = "";}}}
			
		xhr_send("FS.put", JSON.stringify({filename:"setting.json", append:false, data: window.btoa(JSON.stringify(old_json))}), function(u){
			if(u.status != "success"){
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = u.status;
				document.getElementById("failed_button").style.display="block";
				return;
			}
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = "Configuration Saved"
				document.getElementById("success_button").style.display="block";
				save_eth_conf(old_json.eth_en, IP, GW, SN, old_json.i2c_en);	
				load_conf_login();
				var xhttp2 = new XMLHttpRequest();
				xhttp2.open("POST", "/rpc/setting", true);
				xhttp2.send();
		});//end of fs.put
		});//end of fs.get
		});//validate cookie		
		save_command = false;
	}//save conf function
function save_eth_conf(en, ip, gw, netmask, i2c_en){
	var xhttp = new XMLHttpRequest();
	xhttp.open("POST", "/rpc/Config.Set", true);
	xhttp.setRequestHeader('Content-Type', 'application/json');
	var contain = {"config": {"i2c":{"enable":i2c_en}, "eth": {"enable": en, "ip": ip, "gw": gw, "netmask":netmask}}};
	xhttp.send(JSON.stringify(contain));
}

function reboot(){
if(!check_password()){
	reboot_command = true;
	on_overlay_login(2);
	return;
}
on_overlay();document.getElementById("circularG").style.display = 'block';
document.getElementById("spinner_info").innerHTML = "";
validate_cookie(function(i){
	if(i.code == 200 && i.data.status == "illegal"){reboot_command = true;on_overlay();document.getElementById("circularG").style.display = 'none';
		document.getElementById("spinner_info").innerHTML = "Session end, please re-login!";document.getElementById("relogin_button").style.display="block";
		return;
	}else if(i.code != 200){
	var ext_btn = '<div><input type="button" style="font-size:16px" value="retry" onClick="reboot()">';
	ext_btn += '<input style="font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>';
	document.getElementById("spinner_info").innerHTML = (i.status + '<br><br>' + ext_btn); document.getElementById("circularG").style.display = 'none';
	return;}
	off_overlay();
	setTimeout(function(){
	var con = confirm("Proceed to reboot?");
	if(con){
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/Sys.Reboot", true);
		xhr.send();
	}	
	},100);
});//end of validate_cookie
reboot_command = false;
}
function fetch_version(){
	var xhttp = new XMLHttpRequest();
	xhttp.open("POST", "/rpc/Sys.GetInfo", true);
	xhttp.send();
	xhttp.onload = function(){
		sys_info = JSON.parse(this.responseText);
		document.getElementById("fw_version").innerHTML = "<p>Build Version: " + sys_info.fw_version + "</p>";
	}
}
function getconfig(){
document.getElementById("IP").value = sys_info.eth.ip;
}
function on_overlay() {
	document.getElementById("overlay_save").style.display = "block";
	document.getElementById("main_div").style.filter = "blur(2px)";
	document.getElementById("overlay_save").style.filter = "none";
	document.getElementById("failed_button").style.display="none";
	document.getElementById("success_button").style.display="none";
	document.getElementById("relogin_button").style.display="none";
	document.getElementById("refresh_button").style.display="none";
}
function off_overlay_cb(cb){
off_overlay();
cb();
}
function off_overlay() {
  document.getElementById("overlay_save").style.display = "none";
  document.getElementById("main_div").style.filter = "none";
  document.getElementById("relogin_button").style.display="none";
  document.getElementById("success_button").style.display="none";
  document.getElementById("failed_button").style.display="none";
  document.getElementById("refresh_button").style.display="none";
  
}
function on_overlay_wifi(){
  document.getElementById("overlay_wifi").style.display = "block";
  document.getElementById("main_div").style.filter = "blur(2px)";
  document.getElementById("overlay_wifi").style.filter = "none";
  document.getElementById("scan_wifi").disabled = false;
  document.getElementById("scan_result").innerHTML = "Press Scan Button to start wifi scanning!";
  document.getElementById("wifi_warning").innerHTML = "";
  document.getElementById("save_wifi").value = "save";
  document.getElementById("wifi_pass").value = "";
  document.getElementById("wifi_ssid").value = "";
  document.getElementById("save_wifi").disabled = false;
  document.getElementById("cancel_wifi").style.display = "inline";
}


function off_overlay_wifi(){
  document.getElementById("overlay_wifi").style.display = "none";
  document.getElementById("main_div").style.filter = "none";
  load_conf();
  
}
var spinner_load= '<div id="circularG" style="margin-top:-5px"><div id="circularG_1" class="circularG"></div>';
spinner_load += '<div id="circularG_2" class="circularG"></div>';
spinner_load += '<div id="circularG_3" class="circularG"></div><div id="circularG_4" class="circularG"></div><div id="circularG_5" class="circularG"></div>';
spinner_load += '<div id="circularG_6" class="circularG"></div><div id="circularG_7" class="circularG"></div><div id="circularG_8" class="circularG"></div></div>';
	
function scan_wifi(){
	document.getElementById("scan_result").innerHTML = spinner_load;
	document.getElementById("scan_wifi").disabled = true;
	xhr_send("wifi.scan", null,  function(i){
		if(i.status == "success"){
			document.getElementById("scan_wifi").disabled = false;
			var data = i.data;
			var build_net="";
			var sec_type = ["OPEN", "WEP", "WPA/PSK", "WPA2/PSK", "WPA2/PSK", "WPA2/ENT"];
			for(var i = 0; i < data.length; i++){
				var b = data[i].ssid.replace(/'/g, "\\'");
				b = b.replace(/"/g, '&#34;');
				var a = data[i].ssid.replace(/'/g, '&#39;');
				a = a.replace(/"/g, '&#34;');
				build_net += '<table style="width:100%; vertical-align:top"><tr style="height:10px;  vertical-align:top">';
				build_net += '<td style="font-size:14px;  text-align:left;padding-top:3px">';
				build_net += '<span onClick="wifi_list(\''+b+'\')" style="width:100%;border:none; text-align:left; word-break: break-all; white-space:normal;cursor:pointer">'+a+'</span>';
				build_net += '</td><td style="width:20%;text-align:right">';
				build_net += sec_type[data[i].auth];
				build_net += '</td><td style="width:15%;text-align:right">';
				build_net += dbm_2_percent(data[i].rssi);;
				build_net += '</td></table>';
			}
			document.getElementById("scan_result").innerHTML = build_net;
		}else{
			document.getElementById("scan_result").innerHTML = i.status;
		}
	});
}

function fetch_wifi_status(){
var c = "";
document.getElementById("wifi_info0").innerHTML = "";
document.getElementById("wifi_info1").innerHTML = "";
xhr_send("wifi.status", null,  function(i){
	if(i.data.ap_en){ // ap_mode
	c += "<div><b>AP SSID</b>: " + i.data.ap_ssid + "</div>";
	c += "<div><b>Key</b> : " + i.data.ap_pass + "</div>";
	c += "<div style='margin-bottom:10px'><b>IP</b>&nbsp; : " + i.data.ap_ip + "</div>";
	document.getElementById("wifi_info0").innerHTML = c;
	}
	if(i.data.sta_en){ // sta mode
	fetch_wifi_status_sec(i.data.sta_rssi);
	}
});
}

function fetch_wifi_status_sec(input1){
var c = "";
c += "<div><b>Client SSID</b>: " + sys_info.wifi.ssid +"</div>";
c += "<div><b>RSSI</b>: " + input1 + " dBm</div>"; 
c += "<div style='margin-bottom:10px'><b>IP</b> : " + sys_info.wifi.sta_ip + "</div>";
document.getElementById("wifi_info1").innerHTML = c;
}

function connect_wifi(){
	if(!check_password()){
		save_command_wifi = true;
		on_overlay_login(2);
		return;
	}
	var ssid_saved = document.getElementById("wifi_ssid").value;
	var x = document.getElementById("wifi_warning");
	x.innerHTML = "";
	var pass_saved = document.getElementById("wifi_pass").value;
	if(ssid_saved == ""){x.innerHTML = "SSID cannot be empty!";	return;}
	if(ssid_saved.length > 31){x.innerHTML = "SSID must be between 1 to 31 chars";return;}
	if(pass_saved != "" && (pass_saved.length < 5 || pass_saved.length > 63)){x.innerHTML = "password must be between 8 to 63 chars!";return;}
	var json_ssid = {ssid:ssid_saved, pass:pass_saved};
	json_ssid = JSON.stringify(json_ssid);
	document.getElementById("save_wifi").disabled = true;
	x.innerHTML = spinner_load; //pop spinner up
	validate_cookie(function(i){
		if(i.code == 200 && i.data.status == "illegal"){
			save_command_wifi = true;
			on_overlay();
			document.getElementById("circularG").style.display = 'none';
			document.getElementById("spinner_info").innerHTML = "Session end, please re-login!";
			document.getElementById("relogin_button").style.display="block";
			return;
		}else if(i.code != 200){
			save_command_wifi = true;
			x.innerHTML = i.status;
			document.getElementById("save_wifi").disabled = false;
			return;
		}
		
	xhr_send("FS.get", JSON.stringify({filename:"setting.json"}), function(i){
	if(i.status != "success"){
	x.innerHTML = i.status;
	document.getElementById("save_wifi").disabled = false;
	return;
	}
	data = i.data;
	data = JSON.parse(window.atob(data.data));
	for (var i = 0; i < 3; i++){if(data.wifi.cfg[i].ssid == ssid_saved){x.innerHTML = "Same SSID name is already saved!";document.getElementById("save_wifi").disabled = false;return;}
		if(data.wifi.cfg[i].ssid == ""){data.wifi.cfg[i].ssid = ssid_saved;data.wifi.cfg[i].pass = pass_saved;break;}
		if(i == 2){x.innerHTML = "WiFi credentials storage is full (Max 3)!";document.getElementById("save_wifi").disabled = false;	return;}
	}
	var string = window.btoa(JSON.stringify(data));
	var contain = {"filename": "setting.json", "append":false, "data": string}
	xhr_send("fs.put", JSON.stringify(contain), function(m){
	if(m.status != "success"){
		x.innerHTML = m.status;
		document.getElementById("save_wifi").disabled = false;
		return;
	}
	x.innerHTML = "Configuration saved! New config will be applied on reboot.";
	document.getElementById("save_wifi").disabled = false;
	document.getElementById("save_wifi").value = "OK";
	document.getElementById("cancel_wifi").style.display="none";
	}); //end of fs.put
	}); //end of fs.get
	}); //end of validate_cookie
}
function wifi_list(input){
	document.getElementById("wifi_ssid").value = input;
	document.getElementById("wifi_pass").focus();
	document.getElementById("wifi_pass").value = "";
}
function build_wifi_saved_list(input){
var b = "";
for (var i = 0; i < 3 ; i++){
if(input[i].ssid != ""){
b += '<div style="margin-top:5px;margin-bottom:5px"><input type="checkbox" id="wifi_saved'+i+'" value="'+i+'">';
b += '<label for="wifi_saved'+i+'">'+input[i].ssid+'</label></div>';
}
}//for
b += "<div style='margin-top:15px; margin-bttom:5px'><b>* Checked Networks will be deleted on save<br>* WiFi settings updated on reboot</b></div>"
document.getElementById("wifi_saved_list").innerHTML = b;
}
function dbm_2_percent(input){
var quality;
if(input <= -100){
    quality = 0;
}else if(input >= -50){
	quality = 100;
}else{
    quality = 2 * (input + 100);
}
return quality+"%";
}
//ota
const form = document.querySelector("#uploadform");
form.addEventListener("submit", e => {

	document.getElementById("progress_holder").innerHTML = '<div id="myProgress"><div id="myBar"></div>	</div><div id="status">0%</div>';
	e.preventDefault();
	var files = document.querySelector("[id=file]").files[0];
	var data = new FormData();
	data.append("update", files);
	console.log(data);
	var xhr = new XMLHttpRequest();
	xhr.upload.onprogress = function(evt){
		if(evt.lengthComputable){
			var per = evt.loaded/evt.total;
			var percentval = Math.round(per*100) + '%';
			document.getElementById("status").innerHTML = percentval;
			document.getElementById("myBar").style.width = percentval;
		}
	};
	xhr.onloadend = function (e) {
		document.getElementById("status").innerHTML = "file uploaded";
		on_overlay();
		document.getElementById("circularG").style.display="none";
		document.getElementById("spinner_info").innerHTML = "file uploaded!";
		document.getElementById("refresh_button").style.display="block";
		console.log("end");
	}
	xhr.addEventListener("error", function(e){
		document.getElementById("status").innerHTML = "uploading error";
	});
	xhr.open("POST", "/update");
	xhr.send(data);
	
});

function upload_fw(){ //done
if(!check_password()){
	save_command_update = true;
	on_overlay_login(2);
	return;
}
on_overlay();document.getElementById("circularG").style.display = 'block';
document.getElementById("spinner_info").innerHTML = "";
validate_cookie(function(i){
	if(i.code == 200 && i.data.status == "illegal"){save_command_update = true;on_overlay();document.getElementById("circularG").style.display = 'none';
		document.getElementById("spinner_info").innerHTML = "Session end, please re-login!";document.getElementById("relogin_button").style.display="block";
		return;
	}else if(i.code != 200){ 
	var ext_btn = '<div><input type="button" style="font-size:16px" value="retry" onClick="upload_fw()">';
	ext_btn += '<input style="font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>';
	document.getElementById("spinner_info").innerHTML = (i.status + '<br><br>' + ext_btn); document.getElementById("circularG").style.display = 'none';
	return;}
	off_overlay();
	document.getElementById("update_file").click();
});//validate_cookie
save_command_update = false;
}
</script>

<style>
	.sliding_range {
		-webkit-appearance: none;
		width: 50%;
		height: 15px;
		border-radius: 5px;  
		outline: none;
		opacity: 0.7;
		margin-top:15px;
		margin-bottom:15px;
		-webkit-transition: .2s;
		transition: opacity .2s;
	}

	.sliding_range:hover {
	  opacity: 1;
	}

	.sliding_range::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 25px;
		height: 25px;
		border-radius: 50%;
		cursor: pointer;
	}

.sliding_range::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  cursor: pointer;
}
#myProgress {
width: 95%;
background-color: #ddd;
margin-top:10px;
margin-left:auto;
border-radius:10px;
margin-right:auto;
}

#myBar {
width: 0%;
height: 15px;
border-radius:10px;
background-color: #4CAF50;
}
#status{
text-align:center;
margin: 10px;;
}

</style>
</html>
