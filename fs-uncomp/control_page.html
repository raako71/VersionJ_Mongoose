<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title> Control Logic</title>
	<link id="theme" rel="stylesheet" type="text/css"  href="dark.css"/>
    <link rel="stylesheet" type="text/css" href="./general.css" />
	<script src="./login.js.gz" defer></script>
</head>
<body>
<div id="overlay_time_setting" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="time_setting_box">
</div>
</div>
<div id="overlay_save" class="overlay" style="display:none;">
  <div class="confirmation_box" >
  <div id="circularG" >
	<div id="circularG_1" class="circularG"></div>
	<div id="circularG_2" class="circularG"></div>
	<div id="circularG_3" class="circularG"></div>
	<div id="circularG_4" class="circularG"></div>
	<div id="circularG_5" class="circularG"></div>
	<div id="circularG_6" class="circularG"></div>
	<div id="circularG_7" class="circularG"></div>
	<div id="circularG_8" class="circularG"></div>
  </div>
  <div style="margin-top:30px;font-size:20px" id="spinner_info"> Saving.. </div>
  <div class="invsi_button" id="failed_button"> 
  <input type="button" style="font-size:16px" value="retry" onClick="save_conf()"> <input style="font-size:16px" type="button" value="cancel" onClick="off_overlay()"></div>
  <div class="invsi_button" id="success_button">
  <input type="button" style="font-size:16px" value="OK" onClick="off_overlay();load_conf();"></div>
  <div class="invsi_button" id="relogin_button">
  <input type="button" style="font-size:16px;" value="OK" onClick="off_overlay();on_overlay_login(2);"></div>
  </div>
</div>
<!--overlay login-->
<div id="overlay_login" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="multipurpose">
</div>
</div>
<div id="overlay_change_pass" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box">
<b>Change Password</b><br>
<div style="text-align:left;padding-left:10%; padding-right:10%;margin-top:10px">
<span id="old_password_holder">Existing Password: <input type="password" style="width:100%; margin-bottom:5px" id="old_password"></span><br>
New Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass1"><br>
Confirm Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass2"><br>
</div>
<span style="margin-top:10px;display:block;" id="change_pass_warning"></span>
<div style="margin-top:10px">
<input type="button" style="margin:10px;width:100px" id="confirm_change_password" onClick="change_pass_info()" value="OK"><input id="cancel_change_password" style="margin:10px;width:100px" type="button" value="CANCEL" onClick="off_overlay_change_pass();on_overlay_login(2)">
</div>
</div> 
</div>
<!--eof overlay login-->
<div id="main_div">
<div class="top_panel">
<span style="float:left;margin-left:25px;padding:5px" id="clock_info">
</span>
<span style="float:right;margin-right:25px;padding:5px">
<span id='log_info'>Logged in</span>
<span class='dropdown'><input type="button" class="dropbtn" style="margin-left:25px" value = "menu">
<div class="dropdown-content" id="dropdown_menu">
 </div>
 </span>
</span>
</div>
	<h1 id="home_text_disp" style="display:inline"> Socket Controller Dashboard</h1> <h1 style="display:inline-block">&nbsp;Control Logic</h1>

	<div class="main_container">
	<h3 id="uptime"> DEVICE UPTIME: </h3>
	<div class="section">
	<b>Outputs</b>
	<br>
	<div style="margin-bottom:5px; margin-top:5px">
	A: <span id="relay1_prog" > </span>&nbsp;&nbsp;<span id="relay1_sta" > </span>&nbsp;&nbsp;
	<span id="ovr_out_A" style="color:red;display:none">OVERRIDE</span>
	</div>
	<div style="margin-bottom:5px; margin-top:5px">
	B: <span id="relay2_prog"></span>&nbsp;&nbsp;<span id="relay2_sta"></span>&nbsp;&nbsp;
	<span id="ovr_out_B" style="color:red;display:none">OVERRIDE</span>
	</div>
	<div style="margin-bottom:5px; margin-top:5px;display:none" id="led_prog_holder">
	C: <span id="led_prog"></span>&nbsp;&nbsp;<span id="led_sta"></span>&nbsp;&nbsp;
	<span id="ovr_out_C" style="color:red;display:none">OVERRIDE</span>
	</div>
	<div style="margin-bottom:5px; margin-top:5px; display:none" id="IO14_holder" >
	<input type="checkbox" id="IO14_en" onClick="IO14_en_func(this)"> <label for="IO14_en"> D: </label><span id="IO14_prog"></span>&nbsp;&nbsp;<span id="IO14_sta"></span>
	&nbsp;&nbsp; <span id="ovr_out_D" style="color:red;display:none">OVERRIDE</span>
	</div>
	</div>
	<div class="section">
	<b> Programs (descending priority)</b>
	<div id="program_link"></div>
	<div style="margin-bottom:10px; margin-top:10px">
	<input type="button" value="Create New Program" onClick="new_program()">
	</div>
	</div>
	<div class="section"> <!-- input mode section -->
	<b> Input Mode</b><br>
	<div style="margin-top:15px">Input Control A</div>
	<div id="sens_in_A_holder"><input type="checkbox" id = "sens_in_A" ><label for="sens_in_A"> As Sensor Input </label></div>
	<input type="checkbox" onClick="onchange_ovr_check('A',0)" id = "cont_prog_A"><label for="cont_prog_A"> Output Override (Hold 6 seconds)</label>
	<select style="margin-left:30px" onChange="toggle_mode_grey(this.value, 0);" id="input_A_mode"><option value=1>Push Button</option><option value=2>Toggle</option></select>
	<br>
	<div id="ovr_holder_A" style="padding-left:20px;">
	</div>
	<div style="margin-top:15px">Input Control B</div>
	<div id="sens_in_B_holder"><input type="checkbox" id = "sens_in_B" ><label for="sens_in_B"> As Sensor Input </label></div>
	<input type="checkbox" onClick="onchange_ovr_check('B',1)" id = "cont_prog_B"><label for="cont_prog_B"> Output Override (Hold 6 seconds)</label>
	<select style="margin-left:30px" onChange="toggle_mode_grey(this.value, 1);" id="input_B_mode"><option value=1>Push Button</option><option value=2>Toggle</option></select>
	<br>
	<div id="ovr_holder_B" style="padding-left:20px;">
	</div>
	<div style="margin-top:15px">Input Control C</div>
	
	<div id="sens_in_C_holder"><input type="checkbox" id = "sens_in_C" ><label for="sens_in_C"> As Sensor Input </label></div>
	<div id="ovr_C_option_holder">
	<input type="checkbox" onClick="onchange_ovr_check('C',2)" id = "cont_prog_C"><label for="cont_prog_C"> Output Override (Hold 6 seconds)</label>
	<select style="margin-left:30px" onChange="toggle_mode_grey(this.value, 2);" id="input_C_mode"><option value=1>Push Button</option><option value=2>Toggle</option></select>
	</div>
	<br>
	<div id="ovr_holder_C" style="padding-left:20px;">
	</div>
	<div id="input_control_D_holder" style="margin-top:15px;display:none">
		<div>Input Control D</div>
		<div id="sens_in_D_holder"><input type="checkbox" id = "sens_in_D" ><label for="sens_in_D"> As Sensor Input </label></div>
		<input type="checkbox" onClick="onchange_ovr_check('D',3);" id = "cont_prog_D"><label for="cont_prog_D"> Output Override (Hold 6 seconds)</label>
		<select style="margin-left:30px" onChange="toggle_mode_grey(this.value,3)" id="input_D_mode"><option value=1>Push Button</option><option value=2>Toggle</option></select>
		<br>
		<div id="ovr_holder_D" style="padding-left:20px;">
		</div>
	</div>
	</div>
	<div class="section">
	<b>Programmable Indicator LED</b>
	<br>
	
	<input type="radio" name="programmable_led" id="led_disable" onChange="toggle_led_prog(0)"><label for="led_disable">Disabled</label><br>
	<div id="as_output_holder" style="display:none">
	<input type="radio" name="programmable_led" id="as_output" checked onChange="toggle_led_prog(1)"><label for="as_output">As Output</label></div>
	<input type="radio" name="programmable_led" id="output_stat" onChange="toggle_led_prog(2)"><label for ="output_stat">Show output status</label><br>
	<div id="prog_stat_holder" >
	<input type="radio" name="programmable_led" id="prog_stat" onChange="toggle_led_prog(3)"><label for="prog_stat">Show program status (glowing for program active, On for output active, Off for program inactive)</label></div>
	<span id="prog_led_holder" style="display:block; margin-bottom:10px; margin-top:10px"></span>
	</div>
	
	</div>
	<input type="button" style="margin: 15px auto;" value="SAVE" onClick="save_conf()">
</div>
</body>

<script>
	var dev_offset;
	var dev_mode_global;
	var input_mode_list=["A","B","C","D"];
	var ovr_out_global;
	var program_list=[];
	var LED; var IO14;
	var input_C_sense;var input_A_sense; var input_B_sense;	var input_D_sense;
	window.addEventListener('load', onLoad);
	
	function onLoad(){
		update_time();
		console.log("DOM loaded");
		fetch_uptime();
		fetch_program_list();
		setInterval(update_time, 1000);	
	}
	function fetch_program_list(){
		console.log("fetch program list");
		var i ;
		var j = 0;
		for(i = 1 ; i <= 10; i++){
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/FS.Get", true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		var comm = {"filename": "program"+(i)+".json"};
		xhr.send(JSON.stringify(comm));
		xhr.onload = function() {
		var data = JSON.parse(this.responseText);
		if(data.code == 400){
			console.log("no good");
		}else{
			var prog_json = JSON.parse(window.atob(data.data));
			program_list[prog_json.id-1] = JSON.parse(window.atob(data.data));
		}
		j++;
		if(j == 10){
			fetch_IO_status();
			load_conf();	
		}
	
		}
		}//for
	}
	
	function new_program(){
		var i = 0;
		var id;
		for(i = 0; i < 11; i++){
			if(i == 10){ alert("program full"); return;};
			if(program_list[i] == null){
				id = i+1;
				break;
			}
			
		}
		location.href="program_editor.html.gz?x=new&y=" + id + "&" + Math.random() * Math.random();
	}
	function fetch_uptime(){
		var xhttp = new XMLHttpRequest();	
		xhttp.open("POST", "/rpc/Sys.GetInfo", true);
		xhttp.send();
		xhttp.onload = function(){
			var response = JSON.parse(this.responseText);
			var res = Number(response.uptime);		
			var d = Math.floor(res/86400);
			var h = Math.floor((res - d*86400)/3600) ; 
			var s = res%60; 
			var m = Math.floor((res-(d*86400 + h*3600))/60);
			document.getElementById("uptime").innerHTML = "Device Uptime: " +s+ " s, " + m+ " mins, " + h + " hrs, " + d + " days";	
		}
	}
	function create_program_link(){
		var link = '<ul style="padding-left:20px; margin-top:10px">';
		var i = 0;
		while(i < 10){
			if( program_list[i] != null){
			link += '<table><td><li></li> </td><td style="width:100px"><a href="program_editor.html.gz?x=program' + (i+1) +'&y='+program_list[i].id+'&'+ Math.random() * Math.random()+'">' + program_list[i].name + '</a></td>';
			link+= '<td style="width:15px">';
			if(program_list[i].control_opt == 3 && !LED){
			link+= '<abbr class="title_attr" style="color:red" title="Config error (LED RED)">(!)</abbr></td>';
			}else if(program_list[i].control_opt == 4 && !IO14){
			link+= '<abbr class= "title_attr" style="color:red" title="Config error (IO14)">(!)</abbr></td>';
			}else if((program_list[i].end_date != "" || program_list[i].start_date != "" || program_list[i].days_active != "" || program_list[i].on_time_global != "|-1" || program_list[i].off_time_global != "|-1") && !time_set){
			link+= '<abbr class= "title_attr" style="color:red" title="time not set">(!)</abbr></td>';
			}else if(program_list[i].main_option == 8){
				if(program_list[i].main_info == 1 && !input_A_sense){link+= '<abbr class="title_attr" style="color:red" title="Config error (Input A)">(!)</abbr></td>';}
				if(program_list[i].main_info == 2 && !input_B_sense){link+= '<abbr class="title_attr" style="color:red" title="Config error (Input B)">(!)</abbr></td>';}
				if(program_list[i].main_info == 3 && !input_C_sense){link+= '<abbr class="title_attr" style="color:red" title="Config error (Input C)">(!)</abbr></td>';}
				if(program_list[i].main_info == 4 && !input_D_sense){link+= '<abbr class="title_attr" style="color:red" title="Config error (Input D)">(!)</abbr></td>';}
			}else{
			link+= '</td>';
			}
			link += '<td><input type="button" style="margin-left:10px; margin-right:2px" value="Export" onClick="download_file(\'program'+program_list[i].id+'.json\')"> <input type="button" style="margin-right:10px" value="Delete" onClick="delete_prog('+program_list[i].id+')"></td>';
			link += '<td><label class="mini_switch"><input type="checkbox" id="toggle_program_en_'+(i+1)+'" '+(program_list[i].en ? "checked" : "")+'><span class="mini_slider round" ></span></label>'
			link += '</table>';
			}
			i++;
		}
		link += '</ul>';
		document.getElementById("program_link").innerHTML = link;
	}
	function delete_prog(input){
	var conf = confirm("Are you sure want to delete " + program_list[input-1].name + " program?");
	if(conf){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "/rpc/FS.Remove", true);
	xhr.setRequestHeader('Content-Type', 'application/json');
	var  comm = {  "filename": "program" + input+".json" };
	xhr.send(JSON.stringify(comm));
	xhr.onload = function() {window.location.reload(true)}
	}
	}
	function create_dropdown(){
		var i;
		for(i = 0 ; i < 10; i++){
			if(program_list[i] != null){
			var x = document.getElementById("prog_list");
			var opt = document.createElement("option");
			opt.text = program_list[i].name;
			opt.value = i+1;
			x.add(opt);
			}
		}
	}
	
	
function toggle_output_override(input, num){
	input = String(input);
	var dropdown_menu =  '<div style="margin-bottom:10px;margin-top:10px; display:block;">';
	dropdown_menu += 'Apply over ride  <input type="button" style="margin-left:40px" value="Trigger Override" id="ovr_'+input+'_btn" onClick="send_trigger_ovr_global('+(num+1)+')"> <br>';
	dropdown_menu += '<input type="radio" name="override_'+input+'" id="apply_always_'+input+'" onChange="toggle_override(\''+input+'\')" checked><label for="apply_always_'+input+'" >Always</label><br>';
	dropdown_menu += '<input type="radio" name="override_'+input+'" id="apply_for_'+input+'" onChange="toggle_override(\''+input+'\')"><label for="apply_for_'+input+'" >For</label><br>';
	dropdown_menu += '<div style="padding-left:20px; margin-bottom:5px; margin-top:5px; color:grey" id="ovr_for_holder_'+input+'">';
	dropdown_menu += '<input type="text" class="greycolor" id="ovr_sec_'+input+'" maxlength="2" readOnly>Seconds &nbsp';
	dropdown_menu += '<input type="text" class="greycolor" id="ovr_min_'+input+'" maxlength="2" readOnly>Minutes &nbsp';
    dropdown_menu += '<input type="text" class="greycolor" id="ovr_hour_'+input+'" maxlength="2" readOnly>Hours &nbsp';
	dropdown_menu += '<input type="text" class="greycolor" id="ovr_day_'+input+'" maxlength="2">Days</div>';
	dropdown_menu += '<input type="radio" name="override_'+input+'" id="apply_until_'+input+'" onChange="toggle_override(\''+input+'\')" ><label for="apply_until_'+input+'">Until</label>';
	dropdown_menu += '<div style="padding-left:20px; margin-bottom:10px; margin-top:5px" id="ovr_until_holder_C">';
	dropdown_menu += '<input type=time id="until_time_'+input+'" readOnly></div>';
	dropdown_menu += '<label for="override_action_'+input+'" >Override Actions: </label> <select name="override_action_'+input+'" ';
	dropdown_menu += 'id="override_action_'+input+'" onChange="onchange_ovr_program_en(\''+input+'\')">;'; //adding event handler here
	dropdown_menu += '<option value="2">Invert output status</option><option value="3">Turn on Output</option><option value="4">Turn off Output</option>';
	dropdown_menu += '<option value="5">Toggle Program Enable</option></select>';
	var output_addition = "";
	if(input == 'C' || input == 'D'){
		output_addition += '<label for="override_output_'+input+'"> Apply Override to Output: &nbsp;</label> <select name="override_output_'+input+'" id="override_output_'+input+'" onChange="ovr_schedule_opt_handler(\''+input+'\')"> <option value="1">A</option>';
		output_addition += '<option value="2">B</option><option value="3">C</option><option value="4">D</option></select><br>';
	}
	var ovr_schedule_addition = '<span id="ovr_schedule_holder_'+input+'" style="margin-top:5px"><label for="ovr_schedule_label_'+input+'">';
	ovr_schedule_addition += 'Program: &nbsp;</label><select name="ovr_schedule_label_'+input+'" id="ovr_schedule_prog_'+input+'"></select></span>';
	
	if(document.getElementById("cont_prog_"+input).checked && document.getElementById("input_"+input+"_mode").value == 1){
		dropdown_menu += '<br>' + output_addition +ovr_schedule_addition+ '<div id="override_en_status_'+input+'" style="color:red;display:none">OVERRIDE ACTIVE</div></div>';
		document.getElementById("ovr_holder_"+input).innerHTML = dropdown_menu;
		ovr_schedule_opt_handler(input); 
	}else if(document.getElementById("cont_prog_"+input).checked && document.getElementById("input_"+input+"_mode").value == 2){
		document.getElementById("ovr_holder_"+input).innerHTML = output_addition;
		ovr_schedule_opt_handler(input); 
	}else{
		document.getElementById("ovr_holder_"+input).innerHTML = "";
	}
	
	if(input == 'C' || input == 'D'){
		if(!dev_mode_global && document.getElementById("override_output_"+input) != null){
			document.getElementById("override_output_"+input).remove(2);
			document.getElementById("override_output_"+input).remove(2);
		}
	}
}

function ovr_schedule_opt_handler(input){
	var holder = document.getElementById("ovr_schedule_holder_"+input);
	var selection = document.getElementById("override_action_"+input);
	holder.style.display = (selection.value != 5) ? "none" : "block";
	var i = input_mode_list.indexOf(input);
	if(i >= 2){
		i = document.getElementById("override_output_"+input).value-1;
	}
	var ovr_prog_list = document.getElementById("ovr_schedule_prog_"+input);
	ovr_prog_list.innerHTML = "";
	//checking program 
	for(var x = 0; x < 10; x++){
		if(program_list[x] != null){
			var output_ovrrdn = program_list[x].control_opt;
			if(Number(output_ovrrdn) == (i+1)){
				var opt = document.createElement("option");
				opt.text = program_list[x].name;
				opt.value = x+1;
				ovr_prog_list.add(opt);
			}
		}
	}
	//console.log(input);
	//ovr_btn_color_change();
}	
	function IO14_en_func(halo){
		if(halo.checked){
			var conf = confirm("Are you sure want to enable this output?");
			if(!conf){
				halo.checked = false;
			}else if(document.getElementById("output_stat").checked){
				toggle_led_prog(2);
			}
		}
	}
	function toggle_led_prog(input){
		var a = "Select Program: <select id='prog_led_list'></select>";
		var inner = document.getElementById("prog_led_holder");
		if(input == 0 || input == 1){
			inner.innerHTML = "";
		}else if(input == 3){ //as program status
			inner.innerHTML = a;
			for(var i = 0 ; i < 10; i++){
			if(program_list[i] != null){ //will add existing program to select dropdown
			var x = document.getElementById("prog_led_list");
			var opt = document.createElement("option");
			opt.text = program_list[i].name;
			opt.value = i+1;
			x.add(opt);
			}
			}
		}else if(input == 2){ // as output status
			var b = "Select Output : <select id='prog_led_list'>";
			b += "<option value = '1'> output A</option>";
			b += "<option value = '2'> output B</option>";
			if(document.getElementById("IO14_en").checked){
				b+= "<option value = '4'> output D </option>";
			}
			b+= "</select>";
			inner.innerHTML = b;
		}
	}
	function toggle_override(input) {
		
		if(document.getElementById("apply_for_"+input).checked){
			document.getElementById("ovr_day_"+input).readOnly = false;
			document.getElementById("ovr_hour_"+input).readOnly = false;
			document.getElementById("ovr_sec_"+input).readOnly = false;
			document.getElementById("ovr_min_"+input).readOnly = false;
			document.getElementById("ovr_for_holder_"+input).style.color= "";
		}else{
			document.getElementById("ovr_day_"+input).readOnly = true;
			document.getElementById("ovr_hour_"+input).readOnly = true;
			document.getElementById("ovr_sec_"+input).readOnly = true;
			document.getElementById("ovr_min_"+input).readOnly = true;
			document.getElementById("ovr_for_holder_"+input).style.color= "grey";
		}
		
		if(document.getElementById("apply_until_"+input).checked){
			document.getElementById("until_time_"+input).readOnly = false;
		}else{
			document.getElementById("until_time_"+input).readOnly = true;
		}
	}

	function load_conf(){
	if(typeof setting_json_conf_global === 'undefined'){
		setTimeout(load_conf,100);
		return;
	}
	var old_json = setting_json_conf_global;
	//load theme first
	dev_offset = old_json.timezone;
	
	var c = old_json.ctrl_page.LED;
	var cx= old_json.dev_mode; dev_mode_global = cx;
	input_C_sense = old_json.override[2].sensor;
	input_A_sense = old_json.override[0].sensor;
	input_B_sense = old_json.override[1].sensor;
	input_D_sense = old_json.override[3].sensor;
	/*if(cx){
		document.getElementById("DHT22_switch_holder").style.display = 'inline-block';
	}else{
		document.getElementById("DHT22_switch_holder").style.display = 'none';
	}*/
	
	for(i = 0; i < 4; i++){
		if(document.getElementById("sens_in_"+input_mode_list[i]) != null){
		document.getElementById("input_"+input_mode_list[i]+"_mode").value = old_json.override[i].mode;
		document.getElementById("sens_in_"+input_mode_list[i]).checked = old_json.override[i].sensor;
		document.getElementById("cont_prog_"+input_mode_list[i]).checked = old_json.override[i].output_ovr;
		
		//toggle_output_override(input_mode_list[i], i);
		var zz = i;
		toggle_mode_grey(old_json.override[i].mode, zz);
		//toggle and push button dropdown
		var input_mode_element = document.getElementById("input_"+input_mode_list[i]+"_mode");
		if(input_mode_element != null){
		if(cx){
			if(i == 2){ // if dev mode enabled will load dht22
				//document.getElementById("DHT22_en").checked = old_json.override[i].dht22_en;
				//toggle_dht22_holder();
			}
			input_mode_element.style.display = 'inline-block';
		}else{
			input_mode_element.style.display = 'none';
		}
		}
		//console.log(old_json.override);
		//console.log(i);
		//console.log(old_json.override[i]);
		if(old_json.override[i].output_ovr && old_json.override[i].mode == 1){ //if set as override output
			document.getElementById("override_action_"+input_mode_list[i]).value = old_json.override[i].ovr_act;
			//handler for ovr schedule after signing the value to override action
			ovr_schedule_opt_handler(input_mode_list[i]);
			document.getElementById("ovr_schedule_prog_"+input_mode_list[i]).value = old_json.override[i].ovr_prog;
			var a = old_json.override[i].ovr_limit;
			var b = old_json.override[i].ovr_val;
		//apply override limit
		if(a == 1){
			document.getElementById("apply_always_"+input_mode_list[i]).checked = true;
			toggle_override(input_mode_list[i]);
		}else if(a == 2){
			document.getElementById("apply_for_"+input_mode_list[i]).checked = true;
			toggle_override(input_mode_list[i]);
			b = Number(b);
			var d = Math.floor(b/86400);
			var h = Math.floor((b - d*86400)/3600) ; 
			var s = b%60; 
			var m = Math.floor((b-(d*86400 + h*3600))/60);
			document.getElementById("ovr_sec_"+input_mode_list[i]).value = s;
			document.getElementById("ovr_min_"+input_mode_list[i]).value = m;
			document.getElementById("ovr_hour_"+input_mode_list[i]).value = h;
			document.getElementById("ovr_day_"+input_mode_list[i]).value = d;
		}else{
			
			document.getElementById("apply_until_"+input_mode_list[i]).checked = true;
			toggle_override(input_mode_list[i]);
			var date_local = new Date();
			var offset_local = date_local.getTimezoneOffset()*60;
			b = b- offset_local;
			if(b > 86400){ b = b- 86400;}
			var hh = Math.floor(b/3600);
			hh = (hh < 10) ? ("0"+hh) : hh;
			var mm = (b%3600)/60;
			mm = (mm < 10) ? ("0"+mm) : mm;
			var all = hh + ":" + mm;
	
			document.getElementById("until_time_"+input_mode_list[i]).value = all;
		}		
		if(i >= 2){ //for input C and D override
			document.getElementById("override_output_"+input_mode_list[i]).value = old_json.override[i].output_opt;
			ovr_schedule_opt_handler(input_mode_list[i]);
			document.getElementById("ovr_schedule_prog_"+input_mode_list[i]).value = old_json.override[i].ovr_prog;
		}
		}//end of if input set as override output and mode 1
		else if(old_json.override[i].output_ovr && old_json.override[i].mode == 2){ //if input as override output and mode2
			if(i >= 2){
				document.getElementById("override_output_"+input_mode_list[i]).value = old_json.override[i].output_opt;
			}
		}
		}//if element is not null
	}	
	
	ovr_btn_color_change();
	LED = false;
	if(c == 0){
		document.getElementById("led_disable").checked = true;
	}else if(c == 1){ // c == 1 as output
		LED = true;
		document.getElementById("as_output").checked = true;
	}else if(c == 2){ //c == 2 as output status
		document.getElementById("output_stat").checked = true;
	}else{ // c == 3 as program status
		document.getElementById("prog_stat").checked = true;
	}
	toggle_led_prog(c);
	if(c == 2 || c == 3){
		document.getElementById("prog_led_list").value = old_json.ctrl_page.LED_prog;
	}
	if(cx){
		document.getElementById("as_output_holder").style.display="block";
		document.getElementById("IO14_holder").style.display="block";
		document.getElementById("led_prog_holder").style.display = "block";
		document.getElementById("input_control_D_holder").style.display="block";
		document.getElementById("sens_in_D").checked = true;
	}else{
		document.getElementById("led_prog").style.display = "none";
	}
	document.getElementById("IO14_en").checked = old_json.ctrl_page.IO14;
	IO14 = old_json.ctrl_page.IO14;
	
	
	create_program_link();
	}//end of function
	
	function save_conf(){
	var old_json;
	var ovr_output_1 = document.getElementById("cont_prog_A").checked;
	var ovr_output_2 = document.getElementById("cont_prog_B").checked;
	var ovr_output_3 = document.getElementById("cont_prog_C").checked;
	var ovr_output_4 = false;
	if(document.getElementById("cont_prog_D") != null){
		ovr_output_4 = document.getElementById("cont_prog_D").checked;
	}
	
	if(ovr_output_1 && ovr_output_3){if(document.getElementById("override_output_C").value == 1){alert("Input C overrides same output as Input A!");return;}}
	if(ovr_output_2 && ovr_output_3){if(document.getElementById("override_output_C").value == 2){alert("Input C overrides same output as Input B!");return;}}
	if(ovr_output_1 && ovr_output_4){if(document.getElementById("override_output_D").value == 1){alert("Input D overrides same output as Input A!");return;}}
	if(ovr_output_2 && ovr_output_4){if(document.getElementById("override_output_D").value == 2){alert("Input D overrides same output as Input B!");return;}}
	if(ovr_output_3 && ovr_output_4){
		if(document.getElementById("override_output_D").value == document.getElementById("override_output_C").value){alert("input C overrides same output as Input D!"); return;}
	}
	if(!check_password()){save_command = true;on_overlay_login(2); return}
		
		var g;if(document.getElementById("led_disable").checked){g=0;}else if(document.getElementById("as_output").checked){g=1;}else if(document.getElementById("output_stat").checked){g=2;}else{g=3;}
		var g1 = (g == 2 || g == 3) ? document.getElementById("prog_led_list").value : 0;
		var h = document.getElementById("IO14_en").checked;
		on_overlay();
		document.getElementById("circularG").style.display = 'block';
		document.getElementById("success_button").style.display="none";
		document.getElementById("failed_button").style.display="none";
		document.getElementById("spinner_info").innerHTML = "Saving..";
		validate_cookie(function(i){
			if(i.code == 200 && i.data.status == "illegal"){
				save_command = true;
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = "Session end, please re-login!";
				document.getElementById("relogin_button").style.display="block";
				return;
			}else if(i.code != 200){
				save_command = true;
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = i.status;
				document.getElementById("failed_button").style.display="block";
				return;
			}
		xhr_send("FS.get", JSON.stringify({filename:"setting.json"}), function(i){
			if(i.status != "success"){
			document.getElementById("circularG").style.display = 'none';
			document.getElementById("spinner_info").innerHTML = i.status;
			document.getElementById("failed_button").style.display="block";
			return;
			}
			var data = i.data;old_json = JSON.parse(window.atob(data.data));
			
			old_json.ctrl_page.LED = g;old_json.ctrl_page.IO14 = h;old_json.ctrl_page.LED_prog = g1;
		
			//save setting set as override output
			//old_json.override[2].dht22_en = document.getElementById("DHT22_en").checked;
			for(i=0; i < 4 ; i++){
				var a = document.getElementById("sens_in_"+input_mode_list[i]).checked;
				var b= document.getElementById("cont_prog_"+input_mode_list[i]).checked;	
				var b1 =0;
				old_json.override[i].mode = document.getElementById("input_"+input_mode_list[i]+"_mode").value;
				var e =0;var f ="";
				var c; var d; var d1; var override_action = 0; var ovr_prog_schedule = 0;
				if(b && old_json.override[i].mode == 1){
					c = document.getElementById("apply_always_"+input_mode_list[i]).checked;d = document.getElementById("apply_for_"+input_mode_list[i]).checked;	d1 = document.getElementById("apply_until_"+input_mode_list[i]).checked; override_action = document.getElementById("override_action_"+input_mode_list[i]).value;	
					ovr_prog_schedule = document.getElementById("ovr_schedule_prog_"+input_mode_list[i]).value;
					if(c){e = 1;}else if(d){
						e = 2;f=Number(document.getElementById("ovr_sec_"+input_mode_list[i]).value);f+=Number(document.getElementById("ovr_min_"+input_mode_list[i]).value) * 60;f+=Number(document.getElementById("ovr_hour_"+input_mode_list[i]).value) * 3600;f+=Number(document.getElementById("ovr_day_"+input_mode_list[i]).value) *3600 * 24;
					}else if(d1){
						e = 3;f = document.getElementById("until_time_"+input_mode_list[i]).value;f = f.split(":");var date_local = new Date();var offset_local = date_local.getTimezoneOffset() * 60;f = f[0] * 3600 + f[1] * 60 + offset_local;if(f < 0){f = 86400 + f;}
					}
					if(i >= 2 ){
						old_json.override[i].output_opt = document.getElementById("override_output_"+input_mode_list[i]).value;
					}
				}else if(b && old_json.override[i].mode == 2){ //toggle mode
					if(i >= 2 ){
						old_json.override[i].output_opt = document.getElementById("override_output_"+input_mode_list[i]).value;
					}
				}
				old_json.override[i].sensor = a;
				old_json.override[i].output_ovr = b;
				old_json.override[i].ovr_val = f;
				old_json.override[i].ovr_limit = e;
				old_json.override[i].ovr_act = override_action;
				old_json.override[i].ovr_prog = (override_action == 5) ? Number(ovr_prog_schedule) : 0;
			}
		xhr_send("FS.put", JSON.stringify({filename:"setting.json", append:false, data: window.btoa(JSON.stringify(old_json))}), function(u){
			if(u.status != "success"){
				document.getElementById("circularG").style.display = 'none';
				document.getElementById("spinner_info").innerHTML = u.status;
				document.getElementById("failed_button").style.display="block";
				return;
			}
			
		//save program enable if any change detected
		for(prog_num = 0; prog_num < 10 ; prog_num++){ //prog_num is just an index
			if(program_list[prog_num] != null){
				var en_change = document.getElementById("toggle_program_en_"+(prog_num+1)).checked;
				if(en_change != program_list[prog_num].en){ //change detected
					program_list[prog_num].en = en_change;
					xhr_send("FS.put", JSON.stringify({filename:"program"+(prog_num+1)+".json", append:false, data: window.btoa(JSON.stringify(program_list[prog_num]))}), function(v){
					});
				}
			}
		}
			setting_json_conf_global = old_json;
			document.getElementById("circularG").style.display = 'none';
			document.getElementById("spinner_info").innerHTML = "Configuration Saved"
			document.getElementById("success_button").style.display="block";
			var xhttp2 = new XMLHttpRequest();
			xhttp2.open("POST", "/rpc/setting", true);
			xhttp2.send();
		
			});//end of fs put
			});//end of fs.get
		});//end of validate_cookie
		save_command = false;
	}//end of function
	function ovr_btn_color_change(){
	
		if(ovr_out_global != null){
			for(i = 0; i< 4; i++){
			//trigger override button color change
			var x = ovr_out_global[i].split(",");
			var xy = document.getElementById("ovr_"+input_mode_list[i]+"_btn");
			if(xy != null){
			if(Number(x[0]) == 1 ){
				xy.style.color = "white";
				xy.style.backgroundColor = "#0d8e0a"
				xy.style.borderColor = "#0d8e0a";
			}else if(Number(x[0]) == 0){
				xy.style.color = "white";
				xy.style.backgroundColor = "red"
				xy.style.borderColor = "red";
			}
			
			if(document.getElementById("override_action_"+input_mode_list[i]).value == 5 || Number(x[0]) == -1){
				xy.style.color = null;
				xy.style.backgroundColor = null;
				xy.style.borderColor = null;
			}
			}//element is not null
			}//end of for
		
		}
	}
	function fetch_IO_status(){
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST", "/rpc/req_widget", true);
		xhttp.setRequestHeader('Content-Type', 'application/json');
		xhttp.send();
		xhttp.onload = function(){
			var json_data = JSON.parse(xhttp.responseText);
			var ovr_en = json_data.ovr_en;
			var ovr_out_local = json_data.ovr_out;
			ovr_out_global = ovr_out_local.split("|");
			document.getElementById("ovr_out_A").style.display = 'none';
			document.getElementById("ovr_out_B").style.display = 'none';
			document.getElementById("ovr_out_C").style.display = 'none';
			document.getElementById("ovr_out_D").style.display = 'none';
			ovr_btn_color_change();
			for (i = 0; i < 4; i++){
				var x = ovr_out_global[i].split(",");
						
				if(x[1] != -1){
					if(document.getElementById("ovr_out_"+input_mode_list[x[1]]) != null){
					if(x[0] != -1){
						document.getElementById("ovr_out_"+input_mode_list[x[1]]).style.display = "inline-block";
					}
					}
				}
				if(document.getElementById("override_en_status_"+input_mode_list[i]) != null){
					document.getElementById("override_en_status_"+input_mode_list[i]).style.display = (ovr_en[i]=='1') ? 'block' : 'none';
				}
			}
			json_data = json_data.IO_info;
			var a_el = document.getElementById("relay1_sta");
			var b_el = document.getElementById("relay2_sta");
			var c_el = document.getElementById("IO14_sta");
			var d_el = document.getElementById("led_sta");
			var a1_el = document.getElementById("relay1_prog");
			var b1_el = document.getElementById("relay2_prog");
			var c1_el = document.getElementById("IO14_prog");
			var d1_el = document.getElementById("led_prog");
			var pin_state = json_data.pin_state
			var prog_name = json_data.prog_name;
			prog_name = prog_name.split(",");
			var prog_state = json_data.prog_state;
			var prog_state1;
			var prog_state2;
			var prog_state3;
			var prog_state4;
			
			
			if(prog_state[0] == '1'){
			a1_el.className = "on_label";
			prog_state1 = program_list[prog_name[0]-1].name + " ";
			}else{
			var a = (prog_state[0] == '2') ? "Scheduled" : "Inactive";
			a1_el.className = "off_label_prog";
			prog_state1 = a+" ";
			}
			if(prog_state[1] == '1'){
			b1_el.className = "on_label";
			prog_state2 = program_list[prog_name[1]-1].name + " ";
			}else{
			var a = (prog_state[1] == '2') ? "Scheduled" : "Inactive";
			b1_el.className = "off_label_prog";
			prog_state2 =  a+" ";
			}
			if(prog_state[2] == '1'){
			d1_el.className = "on_label";
			prog_state3 = program_list[prog_name[2]-1].name + " ";
			}else{
			var a = (prog_state[2] == '2') ? "Scheduled" : "Inactive";
			d1_el.className = "off_label_prog";
			prog_state3 =  a+" ";
			}
			if(prog_state[3] == '1'){
			prog_state4 = program_list[prog_name[3]-1].name + " ";
			c1_el.className = "on_label";
			}else{
			var a = (prog_state[3] == '2') ? "Scheduled" : "Inactive";
			c1_el.className = "off_label_prog";
			prog_state4 = a+" ";
			}
			
			a1_el.innerHTML = prog_state1;
			b1_el.innerHTML = prog_state2;
			d1_el.innerHTML = prog_state3;
			c1_el.innerHTML = prog_state4;
			
			if(pin_state[0] == '1'){
				a_el.className = "on_label";
				a_el.innerHTML = "Output: ON";
			}else{
				a_el.className = "off_label";
				a_el.innerHTML = "Output: OFF";
			}
			if(pin_state[1] == '1'){
				b_el.className = "on_label";
				b_el.innerHTML = "Output: ON";
			}else{
				b_el.className = "off_label";
				b_el.innerHTML = "Output: OFF";
			}
			if(pin_state[3] == 1){
				c_el.className = "on_label";
				c_el.innerHTML = "Output: ON";
			}else{
				c_el.className = "off_label";
				c_el.innerHTML = "Output: OFF";
			}
			if(pin_state[2] == 1){
				d_el.className = "on_label";
				d_el.innerHTML = "Output: ON";
			}else if(pin_state[2] == 2){
				d_el.className = "off_label";
				d_el.innerHTML = "Scheduled";
			}else if(pin_state[2] == 0){
				d_el.className = "off_label";
				d_el.innerHTML = "Output: OFF ";
			}
		}
	}
	setInterval(function(){
		fetch_uptime();
		fetch_IO_status();
	},2500);
	function download_file(input){
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/rpc/FS.Get", true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		var comm = {"filename": input};
		xhr.send(JSON.stringify(comm));
		xhr.onload = function() {
			var data = JSON.parse(this.responseText);
			var data1 = new Blob([window.atob(data.data)]);
			var link = document.createElement("a");
			link.download = input;
			link.href = URL.createObjectURL(data1);
			link.click();
		}
	}
	function on_overlay() {
	document.getElementById("overlay_save").style.display = "block";
	document.getElementById("main_div").style.filter = "blur(2px)";
	document.getElementById("overlay_save").style.filter = "none";
	document.getElementById("success_button").style.display="none";
	document.getElementById("failed_button").style.display="none";
	document.getElementById("relogin_button").style.display="none";
	}

	function off_overlay() {
	  document.getElementById("overlay_save").style.display = "none";
	  document.getElementById("main_div").style.filter = "none";
	}

function toggle_mode_grey(input, num){
	if(input == 1){
		document.getElementById("sens_in_"+input_mode_list[num]+"_holder").classList.add("unclickable_grey");
		document.getElementById("sens_in_"+input_mode_list[num]).checked = true;
	}else{
		document.getElementById("sens_in_"+input_mode_list[num]+"_holder").classList.add("unclickable_grey");
		document.getElementById("sens_in_"+input_mode_list[num]).checked = false;
	}
	toggle_output_override(input_mode_list[num], num);
}

function onchange_ovr_check(input,num){
	toggle_output_override(input,num);
	ovr_btn_color_change();
}
function onchange_ovr_program_en(input){
	ovr_schedule_opt_handler(input);
	ovr_btn_color_change();
}
</script>

<style>
.on_label{
	background-color: green;
	color:white;
}
.off_label{
	background-color: red;
	color: white;
}
.off_label_prog{
	background-color: orange;
	color: white;
}
.title_attr{
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}
.unclickable_grey{
	color: grey;
	pointer-events: none;
}
.mini_switch {
	position: relative;
	display: inline-block;
	width: 30px;
	height: 18px;
}
.mini_slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: red;
  -webkit-transition: .4s;
  transition: .4s;
}

.mini_slider:before {
  position: absolute;
  content: "";
  height: 13px;
  width: 13px;
  left: 2px;
  bottom: 2.5px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .mini_slider {
	background-color: #0d8e0a;
}
input:checked + .mini_slider:before {
	-webkit-transform: translateX(13px);
	-ms-transform: translateX(13px);
	transform: translateX(13px);
}
.mini_slider.round {border-radius: 15px;}

.mini_slider.round:before { border-radius: 50%;}
</style>
</html>
