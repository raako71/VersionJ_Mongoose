<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title>Socket Controller</title>
	<link id="theme" rel="stylesheet" type="text/css"  href="dark.css?v0.10.3f"/>
    <link rel="stylesheet" type="text/css" href="./general.css?v0.10.3f" />
	<script src="./login.js.gz?v0.10.3f" defer></script>
	<script src="./gauge.min.js.gz"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
	<script type="text/javascript" src="https://d3js.org/d3-dsv.v1.min.js"></script>
	<script type="text/javascript" src="https://d3js.org/d3-fetch.v1.min.js"></script>
</head>
<body>
<div id="overlay_widget_setting" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="widget_setting_box">
</div>
</div>
<div id="overlay_login" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box" id="multipurpose">
</div>
</div>
<div id="overlay_change_pass" class="overlay" style="display:none;font-size:16px">
<div class="confirmation_box">
<b>Change Password</b><br>
<div style="text-align:left;padding-left:10%; padding-right:10%;margin-top:10px">
<span id="old_password_holder">Existing Password: <input type="password" style="width:100%; margin-bottom:5px" id="old_password"></span><br>
New Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass1"><br>
Confirm Password: <input type="password" style="width:100%; margin-bottom:5px" id="new_pass2"><br>
</div>
<span style="margin-top:10px;display:block;" id="change_pass_warning"></span>
<div style="margin-top:10px">
<input type="button" style="margin:10px;width:100px" id="confirm_change_password" onClick="change_pass_info()" value="OK"><input id="cancel_change_password" style="margin:10px;width:100px" type="button" value="CANCEL" onClick="off_overlay_change_pass();on_overlay_login(2)">
</div>
</div> 
</div>
<!--eof overlay-->
<div id="main_div">
<div class="top_panel">
<span style="float:left;margin-left:25px;padding:5px" id="clock_info">
</span>
<span style="float:right;margin-right:25px;padding:5px;">
<span id='log_info'>Logged in</span>
<span class='dropdown'><input type="button" class="dropbtn" style="margin-left:25px" value = "menu">
<div class="dropdown-content">
    <a href="/index.html?v0.10.4">Home</a>
	<a href="/graph.html?v0.10.4">Graph</a>
    <a href="/control_page.html?v0.10.4">Control Logic</a>
    <a href="/setting.html?v0.10.4">Settings</a>
	<a href="#" id="log_button" onClick='login_confirm(this)'>Login</a>
 </div>
 </span>
</span>
</div><!-- top panel-->
<h1> Socket Controller Dashboard</h1>
<div id="widget_cluster">
<div class="widget_holder"><div class="gear-btn" >
<svg height="30" width="30" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:v="https://vecta.io/nano"><circle cx="256" cy="256" r="66.928" fill="#25b6d2"/><path d="M512 294.4v-76.8l-78.112-7.824c-4.464-16.448-11.312-31.904-20.048-46.048l50.368-61.6-54.272-54.304-64.032 52.416c-13.392-7.056-27.776-12.48-42.944-15.888L294.528 0H256.16h-.32-38.368l-8.432 84.352c-15.152 3.424-29.552 8.848-42.944 15.888l-64.032-52.416-54.272 54.304 50.368 61.6c-8.736 14.16-15.568 29.616-20.048 46.048L0 217.6v76.8l78.224 7.824c4.496 16.4 11.248 31.872 19.968 45.984l-50.416 61.648 54.272 54.304 64.032-52.416c13.392 7.056 27.792 12.464 42.96 15.888L217.488 512h38.368.32 38.368l8.432-84.352c15.152-3.424 29.552-8.832 42.96-15.888l64.032 52.416 54.272-54.304-50.416-61.648c8.736-14.144 15.472-29.6 19.968-45.984L512 294.4zm-256.016 77.12c-63.76 0-115.456-51.728-115.456-115.52 0-63.808 51.696-115.52 115.456-115.52S371.44 192.208 371.44 256c0 63.808-51.68 115.52-115.456 115.52z" fill="#32bea6"/></svg></div>
<span class="widget-txt" id="widget1_output"> Output Name </span>
<span class="widget-txt" id="widget1_pin"> Switch Status </span>
<span class="widget-txt" id="widget1_name"> Program Name </span>
<div id="widget1_tanker">
<div class="widget_place"><canvas id="demo0"></canvas></div>
<div class="widget_place"><canvas id="demo1"></canvas></div>
</div>
</div>
</div><!-- main div-->

</body>
<script>
var gauge_1_1;var gauge_1_2;var gauge_1_3;var gauge_1_4;
var gauge_2_1;var gauge_2_2;var gauge_2_3;var gauge_2_4;
var gauge_3_1;var gauge_3_2;var gauge_3_3;var gauge_3_4;
var gauge_4_1;var gauge_4_2;var gauge_4_3;var gauge_4_4;
var gauge_5_1;var gauge_5_2;var gauge_5_3;var gauge_5_4;
var gauge_6_1;var gauge_6_2;var gauge_6_3;var gauge_6_4;
var gauge_7_1;var gauge_7_2;var gauge_7_3;var gauge_7_4;
var gauge_8_1;var gauge_8_2;var gauge_8_3;var gauge_8_4;
var gauge_9_1;var gauge_9_2;var gauge_9_3;var gauge_9_4;
var gauge_10_1;var gauge_10_2;var gauge_10_3;var gauge_10_4;

var chart1; var chart2; var chart3; var chart4; var chart5; var chart6; var chart7; var chart8; var chart9; var chart10;
var program_list = [{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""}, 
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""}, 
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""}, 
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""}, 
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""},
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""},
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""},
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""},
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""},
					{"id": "","name": "", "output":"", "var1":"", "var2":"", "info1":"", "info2":"", "setting":""}];

var opts = {
   angle: 0.18,
      lineWidth: 0.27,
      radiusScale:0.9,
      pointer: {
        length: 0.6,
        strokeWidth: 0.05,
        color: '#FFA700'
      },
      staticLabels: null
      ,
      staticZones: null,
      limitMax: true,
      limitMin: true,
      highDpiSupport: true,
};

window.addEventListener('load', onLoad);
function onLoad(){
setInterval(fetch_io_status, 2500);
setInterval(update_graph, 10000);
update_time();
setInterval(update_time, 1000);	
fetch_program_list();
setTimeout(function() {
  //your code to be executed after 1 second
  //initiate_gauge(1,1,program_list[0].setting.gauge1);
}, 2000);
}
function fetch_program_list(){
	var widget_content = "";
	var i ;
	var j = 0;
	for(i = 1 ; i <= 10; i++){
	var xhr = new XMLHttpRequest();
	xhr.open("POST", "/rpc/FS.Get", true);
	xhr.setRequestHeader('Content-Type', 'application/json');
	var comm = {"filename": "program"+(i)+".json"};
	xhr.send(JSON.stringify(comm));
	xhr.onload = function() {
	var data = JSON.parse(this.responseText);
	if(data.code == 400){
		console.log("no good");
	}else{
		var prog_json = JSON.parse(window.atob(data.data));
		var id = prog_json.id;
		program_list[id-1].name = prog_json.name;
		program_list[id-1].id = prog_json.id;
		program_list[id-1].output = prog_json.control_opt;
		program_list[id-1].var1 = prog_json.control_trigger[0].main_option;
		program_list[id-1].var2 = prog_json.control_trigger[0].sec_option;
		program_list[id-1].info1 = prog_json.control_trigger[0].main_info;
		program_list[id-1].info2 = prog_json.control_trigger[0].sec_info;	
		program_list[id-1].setting = prog_json.setting;
	}
	j++;
	if(j == 10){
	for (k = 0; k < 10; k++){
		if(program_list[k].id != ""){
			widget_content +=widget_builder(k+1);
		}
	}
	document.getElementById("widget_cluster").innerHTML = widget_content;
	for (i = 1; i <= 10; i++){
	var on_off = ["on", "off"];
	var output_list = ["A", "B", "IO16", "IO14", "null"];
	var sens_list = ['Temperature', 'Humidity', 'Light', 'Power'];
	var input_list = ["Relay A Button", "Relay B Button", "Remote Push Button"];
	if(document.getElementById("widget"+i+"_output") != null){
		document.getElementById("widget"+i+"_name").innerHTML = "Program: " + program_list[i-1].name; 
		document.getElementById("widget"+i+"_output").innerHTML = "Output: " + output_list[program_list[i-1].output-1]; 
		var widget_tanker = document.getElementById("widget"+i+"_tanker");
		var v = program_list[i-1].var1;
		var w = program_list[i-1].var2;
		var x = program_list[i-1].info1;
		var y = program_list[i-1].info2;
		if(v >= 1 && v <= 4){
			var text= "";
			var sens = ""; var init_gauge1 =false; init_gauge2 = false;
			x = JSON.parse(x);
			if(x.pri_on != "" || x.pri_off != ""){	
				text += "<span id=\"gaugetxt_"+i +"_" + v+ "\" class=\"gaugetxt\"></span><br>";
				text += "<canvas id=\"gaugecanvas_"+i +"_" + v + "\" height=\"150\" width=\"300\"> </canvas>";
				sens += "<div class=\"widget_place\">" + text + "</div>";
				init_gauge1 = true;
			}	
		    text = "";
			if(w >= 1 && w <= 4){
				if(program_list[i-1].setting.type == 1){
				text += "<span id=\"gaugetxt_"+i +"_" + w+ "\" class=\"gaugetxt\"></span><br>";
				text += "<canvas id=\"gaugecanvas_"+i +"_" + w + "\" height=\"150\" width=\"300\"> </canvas>";	
				sens += "<div class=\"widget_place\">" + text + "</div>";
				}
				init_gauge2 = true;
 			}else if( w== 5){
				y = y.substr(2);
				var v1 = parse_timer(JSON.parse(y), "off");sens +='<div class="widget_place_block">';if(v1 != ""){sens += '<br>Off for ' + v1;}v1 = parse_timer(JSON.parse(y), "on");
				if(v1 != ""){sens += '<br>On for ' + v1;}sens += '</div>'
			}else if (w >= 6 && w <= 9){
				y = JSON.parse(y);
				if(y.sec_on != ""){	
					var sec_on =  String(y.sec_on).split(",");
					text += "ON: output " + output_list[w-6] + " is switched " + on_off[sec_on[1]-1];
					text += "<br>";
				}
				if(y.sec_off != ""){
					var sec_off = String(y.sec_off).split(",");
					text += "OFF: output " + output_list[w-6] + " is switched " + on_off[sec_off[1]-1];
					text += "<br>";
				}
				sens += '<div class="widget_place_block"><br>'+text+'</div>';
			}
			widget_tanker.innerHTML = sens;
			widget_tanker.style.display = (w > 4 ) ? 'block' : 'flex';
			//gauge
			if(init_gauge1 && program_list[i-1].setting.type == 1){initiate_gauge(i, v, program_list[i-1].setting.gauge1);}
			if(init_gauge2 && program_list[i-1].setting.type == 1){initiate_gauge(i, w, program_list[i-1].setting.gauge2);}
			//chart
			if((init_gauge1 || init_gauge2) && program_list[i-1].setting.type == 2){
				var set = {number:0, name1:"", name2:""};
				if(init_gauge1){set.name1 = sens_list[v-1]; set.number = set.number+1;}
				if(init_gauge2){set.name2 = sens_list[w-1]; set.number = set.number+1;}
				initiate_graph(i,v,set);
			}
		}else if(v == 6){
			var v1 = parse_timer(JSON.parse(x), "off");var DC='<div class="widget_place"><br><br>';if(v1 != ""){DC += '<br>Off for ' + v1;}v1 = parse_timer(JSON.parse(x), "on");
			if(v1 != ""){DC += '<br>On for ' + v1;}DC += '</div>';widget_tanker.innerHTML = DC;
		}else if(v == 7){
			widget_tanker.innerHTML = "<div class='widget_place'><br><br><br><b>Manual Operation</b></div>";
		}else if(v == 8){
			var rpb;
			rpb = '<div class="widget_place_block"><br><br>Trigger is '+input_list[x-1]+'</div>';
			if( w == 0){
			var v1 = parse_timer(JSON.parse(y), "off");rpb +='<div class="widget_place_block">';if(v1 != ""){rpb += '<br>Off for ' + v1;}
			v1 = parse_timer(JSON.parse(y), "on");if(v1 != ""){rpb += '<br>On for ' + v1;}rpb += '</div>';
			}
			widget_tanker.innerHTML = rpb;
			widget_tanker.style.display =  'block';
		}else if (v == 9){
			var text = "";
			var OS = "";
			x = JSON.parse(x);
			if( w != -1){
				text += "<span id=\"gaugetxt_"+i +"_" + w + "\" class=\"gaugetxt\"></span><br>";
				text += "<canvas id=\"gaugecanvas_"+i +"_" + w + "\" height=\"150\" width=\"300\" style=\"width:300px;height:150px\"> </canvas>";
				OS += "<div class=\"widget_place\">" + text + "</div>";
				text = "";
			}
			if(x.pri_on != ""){	
				var pri_on =  String(x.pri_on).split(",");
				text += "ON: output " + output_list[pri_on[0]-1] + " is switched " + on_off[pri_on[1]-1];
				text += "<br>";
			}
			if(x.pri_off != ""){
				var pri_off = String(x.pri_off).split(",");
				text += "OFF: output " + output_list[pri_off[0]-1] + " is switched " + on_off[pri_off[1]-1];
				text += "<br>";
			}
			if(x.pri_on != "" || x.pri_off != ""){	
			OS += '<div class="widget_place_block"><br><br>'+text+'</div>';text = "";
			}
			widget_tanker.innerHTML = OS;
			widget_tanker.style.display = (w != -1) ? 'block' : 'flex';
			if(w != -1 && program_list[i-1].setting.type == 1){initiate_gauge(i, w, program_list[i-1].setting.gauge2);}
			if(w != -1 && program_list[i-1].setting.type == 2){
				var set = {number:1, name1:"", name2:sens_list[w-1]};
				initiate_graph(i,w,set);
			}
		}
	}// not null
	}//for when finished
	fetch_io_status();
	update_graph();
	}//if j == 10
	}// xhr onload
	}//for
	
}
	
function widget_builder(input){
var a = '<div class="widget_holder" id="widget_holder_'+input+'"><div class="gear-btn" onClick="on_overlay_setting('+input+')">';
a += '<svg height="30" width="30" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:v="https://vecta.io/nano"><circle cx="256" cy="256" r="66.928" fill="#25b6d2"/><path d="M512 294.4v-76.8l-78.112-7.824c-4.464-16.448-11.312-31.904-20.048-46.048l50.368-61.6-54.272-54.304-64.032 52.416c-13.392-7.056-27.776-12.48-42.944-15.888L294.528 0H256.16h-.32-38.368l-8.432 84.352c-15.152 3.424-29.552 8.848-42.944 15.888l-64.032-52.416-54.272 54.304 50.368 61.6c-8.736 14.16-15.568 29.616-20.048 46.048L0 217.6v76.8l78.224 7.824c4.496 16.4 11.248 31.872 19.968 45.984l-50.416 61.648 54.272 54.304 64.032-52.416c13.392 7.056 27.792 12.464 42.96 15.888L217.488 512h38.368.32 38.368l8.432-84.352c15.152-3.424 29.552-8.832 42.96-15.888l64.032 52.416 54.272-54.304-50.416-61.648c8.736-14.144 15.472-29.6 19.968-45.984L512 294.4zm-256.016 77.12c-63.76 0-115.456-51.728-115.456-115.52 0-63.808 51.696-115.52 115.456-115.52S371.44 192.208 371.44 256c0 63.808-51.68 115.52-115.456 115.52z" fill="#32bea6"/></svg>';
a += '</div>';
a += '<span class="widget-txt" id="widget'+input+'_name"> Program Name </span>';
a += '<span class="widget-txt" id="widget'+input+'_pin"> Switch Status </span>';
a += '<span class="widget-txt" id="widget'+input+'_output"> Output Name </span>';
a += '<div id="widget'+input+'_tanker"></div></div>';
return a;
}

function initiate_gauge(progid, ctrl, setting){
var x = JSON.parse(JSON.stringify(opts));
x.pointer.color = (theme_global == 2) ? "#636363": "black";
if(setting.evl){
	var labels_local;
	if(setting.esz){ labels_local = [Number(setting.min), Number(setting.loval), Number(setting.upval), Number(setting.max)];}
	else{labels_local = [Number(setting.min), Number(setting.max)];}
	var staticLabels = {font: "11px sans-serif", labels: labels_local, fractionDigits: 0, color: ((theme_global == 2) ? "#FFA700" : "black")}
	x.staticLabels = staticLabels;
}
if(setting.esz){
x.staticZones = [{strokeStyle: setting.ocolor, min: Number(setting.min), max: Number(setting.loval)}, {strokeStyle: setting.icolor, min: Number(setting.loval), max: Number(setting.upval)}, {strokeStyle: setting.ocolor, min: Number(setting.upval), max: Number(setting.max)}];
}else{
x.staticZones = [{strokeStyle: setting.icolor, min: setting.min, max: setting.max}];
}
eval('gauge_' + progid + "_" + ctrl + "=new Gauge(document.getElementById(\"gaugecanvas_"+progid+"_"+ctrl+"\")).setOptions(x)");
//eval('gauge_' + progid + "_" + ctrl + ".setTextField(document.getElementById(\"gaugetxt_"+progid+"_"+ctrl+"\"))");
eval('gauge_' + progid + "_" + ctrl + ".animationSpeed = 5");
eval('gauge_' + progid + "_" + ctrl + ".maxValue =" + setting.max);
eval('gauge_' + progid + "_" + ctrl + ".setMinValue("+setting.min + ")");
eval('gauge_' + progid + "_" + ctrl + ".set(0)");
}

function initiate_graph(progid,ctrl, setting){ //setting contatin {number:1, name1: "", name2:""}
var chart_config = {
  type: 'line',
  data: {
  datasets: [{
    backgroundColor: 'rgb(222, 91, 64, 0.5)',
	borderColor: 'rgb(204, 53, 22)',
    borderWidth: 1,
	fill: false,
    data: [],
    label: (setting.name1 != "" ? setting.name1 : setting.name2),
    radius: 1,
  }]
  },
  options: {
	animation:false,
	parsing:false,
    plugins: {
	  decimation: {
		enabled: true,
		algorithm: 'lttb',
		samples:60,
		threshold: 60
	  },
    },
	scales:{
		x:{
			type:'time', 
			time:{unit:'second',stepSize: 900,displayFormats: {second:'HH:mm'}}
		}
	}
  }
};
if(setting.number == 2){
chart_config.data.datasets[1] = {fill:false, label: setting.name2, data:[], backgroundColor: 'rgb(34, 117, 227,0.5)', borderColor: 'rgb(2, 88, 201)', radius: 1, borderWidth: 1,};
}
eval('chart' + progid + "=new Chart(document.getElementById(\"gaugecanvas_"+progid+"_"+ctrl+"\"), chart_config)");
}

function parse_timer(input, name){
input = String(input.tick);var array = ["secs", "mins", "hrs", "days"];var a = input.split(",");var ret = "";
if(name == "on"){for (i = 0 ; i < 4 ; i++){ret += (a[i*2] == '1') ? (a[(i*2)+1] + " " + array[i]) : "";}
}else if(name == "off"){var j = 0;for (i = 4 ; i < 8 ; i++){ret += (a[i*2] == '1') ? (a[(i*2)+1] + " " + array[j]) : "";j++;}}
return ret;
}

var thishour_file;

function update_graph(){
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "/mnt/thisHour.csv?" + Math.random() * Math.random(), true);
	xhr.send();
		xhr.onload = function(){
		var data = xhr.responseText;
		var psv = d3.dsvFormat(";");
		thishour_file = psv.parse(data);
	
	if(thishour_file != null){
	var base = thishour_file.map(function(e){
		return filter_epoch(e.epoch);
	});
	var temp = thishour_file.map(function(e){
		var a =  Number(e.column6 == '' ? null : e.column6);
		return ((temp_unit_login == 2) ? C2F(a) : a);
	});
	var hum = thishour_file.map(function(e){
		return Number(e.column7 == '' ? null : e.column7);
	});
	var light = thishour_file.map(function(e){
		return Number(e.column9 == '' ? null : e.column9);
	});
	var power = thishour_file.map(function(e){
		return Number(e.column4 == '' ? null : e.column4);
	});
	var temp_arr = []; var hum_arr = []; var light_arr = []; var power_arr = [];
	for (i = 0; i < base.length ; i++){
		temp_arr.push({x: base[i], y: temp[i]});
		hum_arr.push({x: base[i], y: hum[i]});
		light_arr.push({x: base[i], y: light[i]});
		power_arr.push({x: base[i], y: power[i]});
	}
	
	var sens_val = [temp_arr, hum_arr, light_arr, power_arr];
	for (i = 0 ; i < 10 ; i++){
		if(eval("chart"+(i+1)+ "!= null")){
			//eval("chart"+(i+1)+".data.labels =base");
			if(eval("chart"+(i+1)+".data.datasets[0] != null")){
				if(program_list[i].var1 >= 1 && program_list[i].var1 <= 4){
					eval("chart"+(i+1)+".data.datasets[0].data = sens_val["+(program_list[i].var1 -1)+"]");
				}else if(program_list[i].var1 == 9 && program_list[i].var2 != -1){
					eval("chart"+(i+1)+".data.datasets[0].data = sens_val["+(program_list[i].var2 -1)+"]");
				}
			}
			if(eval("chart"+(i+1)+".data.datasets[1] != null")){
				if(program_list[i].var2 >= 1 && program_list[i].var2 <= 4){
					eval("chart"+(i+1)+".data.datasets[1].data = sens_val["+(program_list[i].var2 -1)+"]");
				}
			}
			eval("chart"+(i+1)+".update()");
		} //if chart exist
	}//for
	}///this hour not null
	}
}

function filter_epoch(input){
	var x = new Date();	var offset = x.getTimezoneOffset();
	var ret =  input * 1000 + (offset * 60000) + dev_offset*1000; 
	return ret;
}

function fetch_io_status(){
xhr_send("req_widget", null, function(i){
if(i.code != 200){return;}
var res = i.data;
var sens = [res.temp, res.hump, res.light, res.power];
var OS = [res.A , res.B, res.LED, res.IO14];
var io_info = res.IO_info;
var a = io_info.prog_name.split(",");
var unit = ["&deg;", "%", "lux", "W"];
for (i = 0 ; i < 10 ; i++){
//show or hide widget
if(document.getElementById("widget_holder_"+(i+1)) != null){
	for(j = 0 ; j < 4 ; j++){
		if(a[j] == (i+1)){ ///match program name 
			if(io_info.prog_state[j] == '1'){ //active program
				document.getElementById("widget_holder_"+(i+1)).style.display = "inline-block";
				break;
			}else{ //inactive program
				document.getElementById("widget_holder_"+(i+1)).style.display = "none";
				break;
			}
		}
		if(j == 3){
			if(program_list[i].output == 5){document.getElementById("widget_holder_"+(i+1)).style.display = "inline-block";} //null output
			else{document.getElementById("widget_holder_"+(i+1)).style.display = "none";}
		}
	}

if(program_list[i].output == 5){
	document.getElementById("widget"+(i+1)+"_pin").style.display = "none";
	document.getElementById("widget"+(i+1)+"_output").style.display = "none";
}else{
	document.getElementById("widget"+(i+1)+"_pin").style.display = "block";
	document.getElementById("widget"+(i+1)+"_output").style.display = "block";
}
}


//update_gauge
if(document.getElementById("widget"+(i+1)+"_pin") != null){
document.getElementById("widget"+(i+1)+"_pin").innerHTML = "Switched: <span " + ((OS[program_list[i].output-1] == 0) ? ">&nbsp; OFF &nbsp;" : "class=\"on_label\">&nbsp; ON &nbsp;") + "</span>"; //update output status
var v1 = program_list[i].var1;var v2 = program_list[i].var2; var type = program_list[i].setting.type;
for (k = 1 ; k <= 4 ; k++){
	var os_pt = document.getElementById("gaugetxt_"+(i+1)+"_"+k);
	if(type == 1 && os_pt != null){os_pt.innerHTML = ((k == 1 && temp_unit_login == 2) ? C2F(sens[k-1]) : sens[k-1]) + " " + unit[k-1] + (k==1 ? (temp_unit_login==1 ? "C" : "F") : "");eval('gauge_' + (i+1) + "_" + k + ".set("+ ((k == 1 && temp_unit_login == 2) ? C2F(sens[k-1]) : sens[k-1]) +")");}
}//loop 1 to 4
}//if not null (update gauge)

}//loop 0 to 9
});//end of xhr_send
}

function off_overlay_setting(){
 document.getElementById("overlay_widget_setting").style.display = "none";
 document.getElementById("main_div").style.filter = "none";
 //reload widget setting
 fetch_program_list();
}
function on_overlay_setting(input){
document.getElementById("overlay_widget_setting").style.display = "block";
document.getElementById("main_div").style.filter = "blur(2px)";
document.getElementById("overlay_widget_setting").style.filter = "none";
///element
var set = program_list[input-1].setting;
var x = setting_page_builder(input);
x += '<div id="setting_info" style="margin-top:10px;font-size:13px"></div>';
x += '<div style="margin:20px auto"><input type="button" value="SAVE" onclick="save_widget_setting('+input+')">';
x += '<input type="button" value="CLOSE" onClick="off_overlay_setting()"></div>';
document.getElementById("widget_setting_box").innerHTML = x;

//load setting
var a = document.getElementById("max_val1");
var b = document.getElementById("min_val1");
var c = document.getElementById("max_val2");
var d = document.getElementById("min_val2");
var e = document.getElementById("static_enable_1");
var f = document.getElementById("static_enable_2");
var g = document.getElementById("label_enable_1");
var h = document.getElementById("label_enable_2");
var i1 = document.getElementById("gauge1_loval");
var j1 = document.getElementById("gauge1_upval");
var k1 = document.getElementById("gauge1_icolor");
var l1 = document.getElementById("gauge1_ocolor");
var i2 = document.getElementById("gauge2_loval");
var j2 = document.getElementById("gauge2_upval");
var k2 = document.getElementById("gauge2_icolor");
var l2 = document.getElementById("gauge2_ocolor");
//load based on main_opt and sec_opt
if( program_list[input-1].var1 >= 1 && program_list[input-1].var1 <= 4){
setInputFilter(document.getElementById("min_val1"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("max_val1"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("gauge1_loval"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("gauge1_upval"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
a.value = set.gauge1.max;b.value = set.gauge1.min;
e.checked = set.gauge1.esz;g.checked = set.gauge1.evl;
i1.value = set.gauge1.loval; j1.value = set.gauge1.upval; k1.value = set.gauge1.icolor; l1.value = set.gauge1.ocolor;
static_zone_loader(e.checked, 1);
}
if((program_list[input-1].var1 == 9 && program_list[input-1].var2 != -1) || (program_list[input-1].var2 >= 1 && program_list[input-1].var2 <= 4)){
setInputFilter(document.getElementById("min_val2"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("max_val2"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("gauge2_loval"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
setInputFilter(document.getElementById("gauge2_upval"), function(value) {  return /^-?\d*[.,]?\d*$/.test(value); });
c.value = set.gauge2.max;d.value = set.gauge2.min;
i2.value = set.gauge2.loval; j2.value = set.gauge2.upval; k2.value = set.gauge2.icolor; l2.value = set.gauge2.ocolor;
f.checked = set.gauge2.esz;h.checked = set.gauge2.evl;
static_zone_loader(f.checked, 2);
}
var set_type = document.getElementById("setting_type");
if(set_type != null){set_type.value = set.type; indicator_loader(set.type);}
}

function setting_page_builder(id){
var trigger = ['Temperature', 'Humidity', 'Light', 'Power'];
var v = program_list[id-1].var1;
var w = program_list[id-1].var2;
var ret = "<b>" + program_list[id-1].name + " Widget</b><br><br>";
if((v >= 1 && v <= 4) || (v == 9 && w != -1)){
ret += '<label for="setting_type">Indicator type: </label><select onchange="indicator_loader(this.value)" name="setting_type" id="setting_type"><option value="1">Gauge</option><option value="2">Graph</option></select>';
ret += '<div id="gauge_setting_holder" ><br>';
if(v != 9){
ret += '<div style="display:inline-block;width:45%;font-size:13px;margin:10px"><b>'+trigger[v-1]+ '</b><br>';
ret += 'min value: <input type="text" id = "min_val1" style="width:60px"><br>';
ret += 'max value: <input type="text" id = "max_val1" style="width:60px"><br>';
ret += 'inside bounds color: <input type="text" id="gauge1_icolor" style="width:60px"><br>';
ret += '<table style="margin-top:5px"><td><label class="mini_switch"><input onchange="static_zone_loader(this.checked, 1)" type="checkbox" id="static_enable_1"><span class="mini_slider round" ></span></label></td>';
ret += '<td>Enable static zones:</td></table>';
ret += '<div style="display:none; margin-top:10px;margin-bottom:10px" id="static_setting_1">';
ret += 'lower range: <input type="text" id="gauge1_loval" style="width:60px"><br>';
ret += 'upper range: <input type="text" id="gauge1_upval" style="width:60px"><br>';
ret += 'outside bounds color: <input type="text" id="gauge1_ocolor" style="width:60px"><br>';
ret += '</div>'; // enable static zone
ret += '<table><td><label class="mini_switch"><input type="checkbox" id="label_enable_1"><span class="mini_slider round" ></span></label></td>';
ret += '<td>Value Labels:</td></table>';
/*ret += '<div style="margin-top:5px;display:none" id="label_setting_1">';
ret += 'min label: <input type="text" id="gauge1_min_label" style="width:50px"><br>';
ret += 'max label: <input type="text" id="gauge1_max_label" style="width:50px">';
ret += '<div id="4set_label_1" style="display:none">';//4 set labels 
ret += 'lower label: <input type="text" id="gauge1_llabel" style="width:50px"><br>';
ret += 'upper label: <input type="text" id="gauge1_ulabel" style="width:50px">';
ret += '</div>';//eof 4 set labels
ret += '</div>'; //eof label setting*/
ret += '</div>';
}
if( w>= 1 && w <= 4){
ret += '<div style="display:inline-block;width:45%;font-size:13px;margin:10px"><b>'+trigger[w-1]+'</b><br>';
ret += 'min value: <input type="text" id="min_val2" style="width:60px"><br>';
ret += 'max value: <input type="text" id="max_val2" style="width:60px"><br>';
ret += 'inside bounds color: <input type="text" id="gauge2_icolor" style="width:60px"><br>';
ret += '<table style="margin-top:5px"><td><label class="mini_switch"><input onchange="static_zone_loader(this.checked, 2)" type="checkbox" id="static_enable_2"><span class="mini_slider round" ></span></label></td>';
ret += '<td>Enable static zones:</td></table>';
ret += '<div style="display:none; margin-top:10px;margin-bottom:10px" id="static_setting_2">';	
ret += 'lower range: <input type="text" id="gauge2_loval" style="width:60px"><br>';
ret += 'upper range: <input type="text" id="gauge2_upval" style="width:60px"><br>';
ret += 'outside bounds color: <input type="text" id="gauge2_ocolor"  style="width:60px"><br>';
ret += '</div>'; // enable static zone
ret += '<table><td><label class="mini_switch"><input type="checkbox" id="label_enable_2"><span class="mini_slider round" ></span></label></td>';
ret += '<td>Value Labels:</td></table>';
/*ret += '<div style="margin-top:5px;display:none" id="label_setting_2">';
ret += 'min label: <input type="text" id="gauge2_min_label" style="width:50px"> <br>';
ret += 'max label: <input type="text" id="gauge2_max_label" style="width:50px">';
ret += '<div id="4set_label_2" style="display:none">';//4 set labels 
ret += 'lower label: <input type="text" id="gauge2_llabel" style="width:50px"><br>';
ret += 'upper label: <input type="text" id="gauge2_ulabel" style="width:50px">';
ret += '</div>';//eof 4 set labels
ret += '</div>';//eof label setting */
ret += '</div>';
}
ret += '</div>';
}
return ret;
}

function indicator_loader(input){
if(input == 1){
document.getElementById("gauge_setting_holder").style.display="flex";
}else{
document.getElementById("gauge_setting_holder").style.display="none";
}
}
function static_zone_loader(input, num){
var x = document.getElementById("static_setting_" + num);
if(input){
x.style.display = "block";
}else{
x.style.display = "none";
}
}

function save_widget_setting(id){
	var z = document.getElementById("setting_type");
	var a = document.getElementById("max_val1");
	var b = document.getElementById("max_val2");
	var c = document.getElementById("min_val1");
	var d = document.getElementById("min_val2");
	var e = document.getElementById("static_enable_1");
	var f = document.getElementById("static_enable_2");
	var g = document.getElementById("label_enable_1");
	var h = document.getElementById("label_enable_2");
	var i1 = document.getElementById("gauge1_loval");
	var j1 = document.getElementById("gauge1_upval");
	var k1 = document.getElementById("gauge1_icolor");
	var l1 = document.getElementById("gauge1_ocolor");
	var i2 = document.getElementById("gauge2_loval");
	var j2 = document.getElementById("gauge2_upval");
	var k2 = document.getElementById("gauge2_icolor");
	var l2 = document.getElementById("gauge2_ocolor");
	
	var old_json;
	//verification before everything
	var info = document.getElementById("setting_info");
	info.innerHTML = "";
	if( a != null){ 
	if( a.value == ""){info.innerHTML = "gauge 1 max value cannot be empty"; return;}
	if( c.value == ""){info.innerHTML = "gauge 1 min value cannot be empty"; return;}
	if(k1.value == ""){info.innerHTML = "gauge 1 inside color cannot be empty"; return;}
	if(e.checked){
	if(i1.value == "" ||j1.value == "" || l1.value == ""){info.innerHTML = "gauge 1 static zone setting is not complete"; return;}
	}
	}
	if( b != null){
	if( b.value == ""){info.innerHTML = "gauge 2 max value cannot be empty"; return;}
	if( d.value == ""){info.innerHTML = "gauge 2 min value cannot be empty"; return;}
	if(k2.value == ""){info.innerHTML = "gauge 2 inside color cannot be empty"; return;}
	if(f.checked){
	if(i2.value == "" ||j2.value == "" || l2.value == ""){info.innerHTML = "gauge 2 static zone setting is not complete"; return;}
	}
	}//a != null
	if(!check_password()){
		save_command_widget = id;
		on_overlay_login(2);
		return;
	}
	on_overlay_login(0); //just on overlay login
	document.getElementById("multipurpose").innerHTML = '<div style="margin-top:30px;font-size:20px" id="spinner_info">'+spinner_load+'</div><br>Saving...';
	validate_cookie(function(i){
	//cookie validation
		if(i.code == 200 && i.data.status == "illegal"){
			save_command_widget = id;
			var x = '<div style="margin-top:30px;font-size:20px" id="spinner_info"> Session end, please re-login! </div>';
			x+= '<br>  <input type="button" style="font-size:16px;" value="OK" onClick="on_overlay_login(2);"></div>';
			document.getElementById("multipurpose").innerHTML = x;
			return;
		}else if(i.code != 200){
			save_command_widget = id;
			var x = '<div style="margin-top:30px;font-size:20px" id="spinner_info">'+i.status+'</div>';
			x+= '<input type="button" style="font-size:16px" value="retry" onClick="save_widget_setting('+id+')"> <input style="font-size:16px" type="button" value="cancel" onClick="off_overlay_login()">';
			document.getElementById("multipurpose").innerHTML = x;
			return;
		}
	
	var set = {type:1, gauge1:{max:1000, min: 0, upval:-1, loval:-1, ocolor:"-1", icolor:"-1", max_label:"", min_label:"", llabel:"", ulabel:""}, 
	gauge2:{max:1000, min: 0, esz: false, evl: false, upval:-1, loval:-1, ocolor:"-1", icolor:"-1", max_label:"", min_label:"", llabel:"", ulabel:""}};
	if(a != null){set.gauge1.max = a.value;}
	if(b != null){set.gauge2.max = b.value;}
	if(c != null){set.gauge1.min = c.value;}
	if(d != null){set.gauge2.min = d.value;}
	if(e != null){set.gauge1.esz = e.checked;}
	if(f != null){set.gauge2.esz = f.checked;}
	if(g != null){set.gauge1.evl = g.checked;}
	if(h != null){set.gauge2.evl = h.checked;}
	if(i1 != null){set.gauge1.loval = i1.value;}
	if(j1 != null){set.gauge1.upval = j1.value;}
	if(k1 != null){set.gauge1.icolor = k1.value;}
	if(l1 != null){set.gauge1.ocolor = l1.value;}
	if(i2 != null){set.gauge2.loval = i2.value;}
	if(j2 != null){set.gauge2.upval = j2.value;}
	if(k2 != null){set.gauge2.icolor = k2.value;}
	if(l2 != null){set.gauge2.ocolor = l2.value;}
	if(z != null){set.type = z.value;}
	//info.innerHTML = spinner_load;
	xhr_send("FS.get", JSON.stringify({filename:"program"+id+".json"}), function(i){
		if(i.code != 200){
		info.innerHTML = i.status;
		return;
		}
		old_json = JSON.parse(window.atob(i.data.data));
		old_json.setting = set;
	xhr_send("FS.put", JSON.stringify({filename:"program"+id+".json", append:false, data: window.btoa(JSON.stringify(old_json))}), function(u){
		if(u.code != 200){
		info.innerHTML = u.status;
		return;
		}
		off_overlay_login();
		info.innerHTML = "Configuration saved";
	});//end of fs put
	});//end of fs get
	});//end of validate cookie
}

function setInputFilter(textbox, inputFilter) {["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {textbox.addEventListener(event, function() {if (inputFilter(this.value)) {this.oldValue = this.value;this.oldSelectionStart = this.selectionStart;this.oldSelectionEnd = this.selectionEnd;} else if (this.hasOwnProperty("oldValue")) {this.value = this.oldValue;this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);} else {this.value = "";}});});}

function C2F(temp){
var ret = (temp * 9/5)+32;
return ret;
}
</script>
<style>
.gear-btn{
height:30px;width:30px;cursor:pointer;margin-top:10px;margin-left: auto; margin-right: 10px;
}
.widget-txt{
display:block;text-align:left;font-size:18px;padding-left:20px; padding:3px 10px;font-weight:bold;
}
.gaugetxt{
    font-size: 1.5em;
    font-weight: bold;
    font-family: 'Amaranth', sans-serif;
}
.mini_switch {
  position: relative;
  display: inline-block;
  width: 30px;
  height: 18px;
}

.mini_slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.mini_slider:before {
  position: absolute;
  content: "";
  height: 13px;
  width: 13px;
  left: 2px;
  bottom: 2.5px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .mini_slider {background-color: #2196F3;}input:checked + .mini_slider:before {-webkit-transform: translateX(13px);-ms-transform: translateX(13px);transform: translateX(13px);}
.mini_slider.round {border-radius: 15px;}

.mini_slider.round:before { border-radius: 50%;}

#gauge_setting_holder{
text-align:left; 
display:flex;
flex-wrap: wrap;
}
</style>
</html>